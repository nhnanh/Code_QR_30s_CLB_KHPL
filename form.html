<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒêi·ªÉm Danh Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Outfit', sans-serif;
            margin: 0; padding: 20px;
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #fff;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }

        .glass-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 24px;
            padding: 30px 25px;
            width: 100%; max-width: 420px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.3);
            position: relative; overflow: hidden;
            transition: transform 0.3s;
        }
        
        h2 { text-align: center; margin: 0 0 25px 0; font-weight: 800; letter-spacing: -0.5px; font-size: 26px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px; }
        input {
            width: 100%; padding: 14px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white; font-size: 16px;
            transition: 0.3s;
        }
        input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.6);
            outline: none; box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        input::placeholder { color: rgba(255, 255, 255, 0.5); }

        .btn {
            width: 100%; padding: 16px;
            background: white; color: #4f46e5;
            border: none; border-radius: 14px;
            font-weight: 700; font-size: 16px;
            cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.7; cursor: wait; }

        .error-box {
            display: none; background: rgba(254, 202, 202, 0.2);
            border: 1px solid rgba(254, 202, 202, 0.4);
            padding: 15px; border-radius: 12px;
            margin-top: 20px; animation: shake 0.4s ease-in-out;
        }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        
        .success-box { display: none; text-align: center; padding: 20px 0; }
        .success-icon { font-size: 60px; margin-bottom: 15px; display: block; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% {transform: scale(0)} 100% {transform: scale(1)} }

        #resetSection { margin-top: 15px; padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.3); display: none; }
        .reset-link { color: rgba(255,255,255,0.8); font-size: 13px; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>
    <div class="glass-container" id="mainForm">
        <h2 id="formTitle"><i class="fa-solid fa-qrcode"></i> ƒêI·ªÇM DANH</h2>
        <div id="dynamicFields"></div>
        <button class="btn" id="btnSubmit" onclick="submitForm()">
            <span>X√ÅC NH·∫¨N</span> <i class="fa-solid fa-arrow-right"></i>
        </button>
        
        <div class="error-box" id="errorBox">
            <div id="errorMsg" style="margin-bottom:10px; font-weight:600; color:#fca5a5"><i class="fa-solid fa-triangle-exclamation"></i> C√≥ l·ªói x·∫£y ra!</div>
            <div id="resetSection">
                <p style="margin:0 0 10px 0; font-size:13px; opacity:0.9">B·∫°n nh·∫≠p sai ho·∫∑c mu·ªën ƒëi·ªÉm danh l·∫°i?</p>
                <div class="form-group" style="margin-bottom:10px">
                     <input type="text" id="resetReason" placeholder="Nh·∫≠p l√Ω do (VD: Nh·∫ßm m√£ SV...)">
                </div>
                <button class="btn" style="background: rgba(239, 68, 68, 0.9); color:white" onclick="requestReset()">
                    <i class="fa-solid fa-rotate-left"></i> G·ª≠i y√™u c·∫ßu Reset
                </button>
            </div>
        </div>
    </div>

    <div class="glass-container success-box" id="successBox">
        <div class="success-icon">üéâ</div>
        <h2 style="margin-bottom:10px">Th√†nh c√¥ng!</h2>
        <p style="opacity:0.9; margin-bottom:5px">H·ªá th·ªëng ƒë√£ ghi nh·∫≠n l√∫c:</p>
        <div style="font-size:24px; font-weight:700; margin-bottom:20px" id="resTime">--:--</div>
        <button class="btn" style="background: rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.3)" onclick="location.reload()">
            ƒêi·ªÉm danh ti·∫øp
        </button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx7qQG5ZzvkYwDEevLTt7lT8tIaGks6bPXVSxpi1i3wH4E5Yv4pk--lMKOc7q32AZ6Q/exec"; 
        
        let formConfig = null;
        let lastSubmitData = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const e = urlParams.get('e');
            if(e && parseInt(e) < Date.now()) {
                document.body.innerHTML = "<div class='glass-container' style='text-align:center; color:#fca5a5'><h2><i class='fa-solid fa-link-slash'></i></h2><h3>LINK ƒê√É H·∫æT H·∫†N</h3></div>";
                return;
            }

            fetch(API_URL + "?action=GET_FORM_CONFIG").then(r => r.json()).then(res => {
                if(res.status === "success" && res.config) renderFields(res.config);
                else renderDefault();
            }).catch(() => renderDefault());
        };

        function renderDefault() {
            renderFields({title: "TH√îNG TIN", fields: [{label:"H·ªç T√™n", type:"text", required:true}, {label:"MSSV", type:"tel", required:true}, {label:"L·ªõp", type:"text", required:true}]});
        }

        function renderFields(cfg) {
            formConfig = cfg;
            document.getElementById('formTitle').innerHTML = `<i class="fa-solid fa-clipboard-user"></i> ${cfg.title}`;
            let html = '';
            cfg.fields.forEach((f, i) => {
                let req = f.required ? 'required' : '';
                html += `<div class="form-group">
                    <label>${f.label} ${f.required?'*':''}</label>
                    <input type="${f.type}" id="field_${i}" placeholder="${f.placeholder||''}" ${req}>
                </div>`;
            });
            document.getElementById('dynamicFields').innerHTML = html;
        }

        function submitForm() {
            const inputs = document.querySelectorAll('#dynamicFields input');
            let data = { action: "CHECK_IN", other_data: [] };
            let hasError = false;

            if(inputs.length > 0) data.name = inputs[0].value;
            if(inputs.length > 1) data.mssv = inputs[1].value;
            if(inputs.length > 2) data.class_name = inputs[2].value;

            inputs.forEach(inp => {
                if(inp.hasAttribute('required') && !inp.value.trim()) {
                    inp.style.borderColor = "#fca5a5";
                    inp.style.backgroundColor = "rgba(254, 202, 202, 0.1)";
                    hasError = true;
                } else {
                    inp.style.borderColor = "rgba(255, 255, 255, 0.2)";
                    inp.style.backgroundColor = "rgba(255, 255, 255, 0.1)";
                    data.other_data.push(inp.value);
                }
            });

            if(hasError) return;
            lastSubmitData = data;

            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêANG X·ª¨ L√ù...';
            document.getElementById('errorBox').style.display = "none";

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(data)
            }).then(() => {
                // Gi·∫£ ƒë·ªãnh th√†nh c√¥ng do no-cors
                document.getElementById('mainForm').style.display = 'none';
                document.getElementById('successBox').style.display = 'block';
                document.getElementById('resTime').innerText = new Date().toLocaleTimeString();
            })
            .catch(err => {
                 btn.disabled = false;
                 btn.innerHTML = '<span>X√ÅC NH·∫¨N</span> <i class="fa-solid fa-arrow-right"></i>';
                 document.getElementById('errorBox').style.display = "block";
                 document.getElementById('errorMsg').innerText = "C√≥ l·ªói k·∫øt n·ªëi ho·∫∑c b·∫°n ƒë√£ ƒëi·ªÉm danh r·ªìi.";
                 document.getElementById('resetSection').style.display = "block";
            });
            
            // Fallback: N·∫øu backend check tr√πng v√† tr·∫£ l·ªói (nh∆∞ng no-cors ko ƒë·ªçc dc), 
            // ta hi·ªán reset button sau 2s n·∫øu user ch∆∞a chuy·ªÉn m√†n h√¨nh (c√°ch "hack" UX)
            setTimeout(() => {
                if(document.getElementById('mainForm').style.display !== 'none') {
                     document.getElementById('resetSection').style.display = "block";
                     document.getElementById('errorBox').style.display = "block";
                     document.getElementById('errorMsg').innerHTML = "N·∫øu h·ªá th·ªëng kh√¥ng ph·∫£n h·ªìi, c√≥ th·ªÉ b·∫°n ƒë√£ ƒëi·ªÉm danh r·ªìi.";
                     btn.disabled = false;
                     btn.innerHTML = '<span>X√ÅC NH·∫¨N</span> <i class="fa-solid fa-arrow-right"></i>';
                }
            }, 3000);
        }
        
        function requestReset() {
            if(!lastSubmitData || !lastSubmitData.mssv) { alert("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin."); return; }
            const reason = document.getElementById('resetReason').value;
            if(!reason) { alert("Vui l√≤ng nh·∫≠p l√Ω do!"); return; }

            const reqData = {
                action: "SEND_REQUEST",
                name: lastSubmitData.name,
                mssv: lastSubmitData.mssv,
                class_name: lastSubmitData.class_name,
                reason: reason
            };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(reqData) })
            .then(() => {
                document.getElementById('resetSection').innerHTML = "<p style='color:#86efac; font-weight:bold; text-align:center'><i class='fa-solid fa-check'></i> ƒê√£ g·ª≠i y√™u c·∫ßu! Vui l√≤ng ƒë·ª£i Admin duy·ªát.</p>";
            });
        }
    </script>
</body>
</html>

