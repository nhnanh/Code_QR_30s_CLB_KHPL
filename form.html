<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√ÅC NH·∫¨N ƒêI·ªÇM DANH</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        
        input { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #3498db; outline: none; }

        /* CSS Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu */
        #name { text-transform: capitalize; }
        /* CSS Vi·∫øt hoa to√†n b·ªô */
        #class_name { text-transform: uppercase; }

        .btn-submit { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-submit:disabled { background: #ccc; }

        .error-msg { color: red; text-align: center; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div class="form-card" id="mainForm">
        <h2>üìã TH√îNG TIN SINH VI√äN</h2>
        <p class="error-msg" id="blockMsg">‚õî THI·∫æT B·ªä N√ÄY ƒê√É ƒêI·ªÇM DANH H√îM NAY!</p>
        
        <form id="attendanceForm">
            <div class="input-group">
                <label>H·ªç v√† t√™n:</label>
                <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required oninput="formatName(this)">
            </div>

            <div class="input-group">
                <label>M√£ sinh vi√™n:</label>
                <input type="number" id="mssv" placeholder="Nh·∫≠p s·ªë..." required pattern="[0-9]*" inputmode="numeric">
            </div>

            <div class="input-group">
                <label>L·ªõp:</label>
                <input type="text" id="class_name" placeholder="K68LUAT..." required oninput="this.value = this.value.toUpperCase()">
            </div>

            <button type="submit" class="btn-submit" id="btnSub">X√ÅC NH·∫¨N ƒêI·ªÇM DANH</button>
        </form>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH API ---
        // Thay link Google Apps Script c·ªßa b·∫°n v√†o ƒë√¢y
        const API_URL = https://script.google.com/macros/s/AKfycbxk2DeAwCVYempdxmVywhV1VD3uUih1GC6tIrDJ71ncvN5h4ScJ3hqfIIEbU82Zlj2q/exec; 

        // --- 2. KI·ªÇM TRA CH·∫∂N THI·∫æT B·ªä (1 l·∫ßn/ng√†y) ---
        const today = new Date().toLocaleDateString('vi-VN');
        const lastAttended = localStorage.getItem('last_attendance_date');

        if (lastAttended === today) {
            document.getElementById('attendanceForm').style.display = 'none';
            document.getElementById('blockMsg').style.display = 'block';
        }

        // --- 3. KI·ªÇM TRA TH·ªúI GIAN QR ---
        const urlParams = new URLSearchParams(window.location.search);
        const qrTime = parseInt(urlParams.get('t'));
        const now = Date.now();

        // N·∫øu QR c≈© qu√° 45 gi√¢y (30s refresh + 15s thao t√°c) -> Ch·∫∑n
        if (!qrTime || (now - qrTime > 45000)) {
            Swal.fire({
                icon: 'error',
                title: 'M√£ QR h·∫øt h·∫°n!',
                text: 'Vui l√≤ng qu√©t m√£ m·ªõi tr√™n m√†n h√¨nh.',
                allowOutsideClick: false,
                showConfirmButton: false
            });
            document.getElementById('btnSub').disabled = true;
        }

        // --- 4. X·ª¨ L√ù FORMAT T√äN (Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu) ---
        function formatName(input) {
            let words = input.value.toLowerCase().split(' ');
            for (let i = 0; i < words.length; i++) {
                words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
            }
            input.value = words.join(' ');
        }

        // --- 5. G·ª¨I D·ªÆ LI·ªÜU ---
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnSub');
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;

            const name = document.getElementById('name').value;
            const mssv = document.getElementById('mssv').value;
            const className = document.getElementById('class_name').value;
            const submitTime = new Date().toLocaleString('vi-VN');

            const data = {
                name: name,
                mssv: mssv,
                class_name: className,
                device_info: navigator.userAgent // L·∫•y th√¥ng tin thi·∫øt b·ªã
            };

            fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
            .then(() => {
                // Ghi nh·∫≠n ƒë√£ ƒëi·ªÉm danh h√¥m nay v√†o b·ªô nh·ªõ m√°y
                localStorage.setItem('last_attendance_date', today);

                // Hi·ªán Popup th√†nh c√¥ng
                Swal.fire({
                    icon: 'success',
                    title: 'ƒêI·ªÇM DANH TH√ÄNH C√îNG!',
                    html: `
                        <div style="text-align:left; font-size:16px;">
                            <p><b>H·ªá th·ªëng ƒë√£ ghi nh·∫≠n:</b></p>
                            <p>üë®‚Äçüéì Sinh vi√™n: <b>${name}</b></p>
                            <p>üÜî MSSV: <b>${mssv}</b></p>
                            <p>‚è∞ L√∫c: <b>${submitTime}</b></p>
                        </div>
                    `,
                    confirmButtonText: 'ƒê√≥ng'
                }).then(() => {
                    // Sau khi ƒë√≥ng popup th√¨ ch·∫∑n lu√¥n form
                    location.reload();
                });
            })
            .catch(err => {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
                btn.disabled = false;
                btn.innerText = "X√ÅC NH·∫¨N ƒêI·ªÇM DANH";
            });
        });
    </script>
</body>
</html>
