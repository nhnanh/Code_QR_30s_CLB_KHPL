<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XÁC NHẬN ĐIỂM DANH</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .hidden { display: none !important; }
        .reset-container { position: absolute; bottom: 20px; width: 100%; text-align: center; }
        .reset-btn { font-size: 13px; color: #666; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Nội dung Form giữ nguyên như cũ, chỉ sửa script bên dưới -->
    
    <script>
        const API_URL = "DÁN_LINK_API_CỦA_BẠN_VÀO_ĐÂY"; 

        // ... (Logic điểm danh cũ giữ nguyên) ...

        // --- LOGIC RESET MỚI ---
        function smartReset() {
            const mssv = localStorage.getItem('my_mssv');

            if (!mssv) {
                // Trường hợp 1: Chưa có MSSV (chưa điểm danh lần nào) -> Hỏi Pass
                askPassword("Nhập mật khẩu Reset để mở khóa:");
                return;
            }

            Swal.fire({ title: 'Đang kiểm tra...', didOpen: () => Swal.showLoading() });

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "CHECK_STATUS", mssv: mssv })
            })
            .then(res => res.json())
            .then(data => {
                Swal.close();
                if (data.exist === true) {
                    // TRƯỜNG HỢP 2: CÓ TÊN TRONG DANH SÁCH -> NHẬP LÝ DO
                    askReason(mssv, data.name, data.class_name);
                } else {
                    // TRƯỜNG HỢP 3: ĐÃ BỊ XÓA -> RESET LUÔN
                    performReset();
                }
            });
        }

        function askReason(mssv, name, className) {
            Swal.fire({
                title: 'YÊU CẦU ĐIỂM DANH LẠI',
                html: `<p>Sinh viên: <b>${name}</b> (${mssv})</p><p>Bạn đang có tên trong danh sách. Hãy nhập lý do để gửi yêu cầu đến Admin.</p>`,
                input: 'textarea',
                inputPlaceholder: 'Nhập lý do (VD: Điền sai thông tin...)',
                showCancelButton: true,
                confirmButtonText: 'Gửi Yêu Cầu'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    // Gửi yêu cầu lên server
                    fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            action: "REQUEST_RESET", 
                            mssv: mssv, name: name, class_name: className, 
                            reason: result.value 
                        })
                    }).then(() => {
                        Swal.fire('Đã gửi!', 'Yêu cầu của bạn đã được gửi. Máy sẽ reset ngay để bạn nhập lại.', 'success')
                        .then(() => { performReset(); });
                    });
                }
            });
        }

        function askPassword(msg) {
            const adminPass = localStorage.getItem('admin_reset_pass') || "Admin";
            Swal.fire({
                title: 'Mở Khóa Thiết Bị', text: msg, input: 'password', showCancelButton: true
            }).then((result) => {
                if (result.value === adminPass) performReset();
                else if (result.isConfirmed) Swal.fire('Lỗi', 'Sai mật khẩu!', 'error');
            });
        }

        function performReset() {
            localStorage.removeItem('attended_today');
            localStorage.removeItem('my_mssv');
            location.reload();
        }
    </script>
</body>
</html>
