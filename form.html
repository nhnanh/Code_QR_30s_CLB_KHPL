<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√ÅC NH·∫¨N ƒêI·ªÇM DANH</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; position: relative; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        #name { text-transform: capitalize; }
        #class_name { text-transform: uppercase; }

        .btn-submit { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-submit:hover { background: #27ae60; }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; }

        .hidden { display: none !important; }
        .error-screen { text-align: center; color: #c0392b; background: #fadbd8; padding: 20px; border-radius: 10px; border: 2px dashed #c0392b; }
        
        /* N√∫t Reset ·∫©n d∆∞·ªõi c√πng */
        .reset-container { position: absolute; bottom: 10px; width: 100%; text-align: center; }
        .reset-btn { font-size: 12px; color: #999; cursor: pointer; text-decoration: none; padding: 5px; }
        .reset-btn:hover { color: #555; text-decoration: underline; }
    </style>
</head>
<body>

    <div class="form-card">
        <!-- 1. M√†n h√¨nh ch·∫∑n -->
        <div id="errorScreen" class="hidden error-screen">
            <h3 id="errTitle">‚õî L·ªñI</h3>
            <p id="errMsg">N·ªôi dung l·ªói</p>
        </div>

        <!-- 2. M√†n h√¨nh Form -->
        <div id="formScreen">
            <h2>üìã ƒêI·ªÇM DANH</h2>
            <form id="attendanceForm">
                <div class="input-group">
                    <label>H·ªç v√† t√™n:</label>
                    <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required oninput="formatName(this)">
                </div>
                <div class="input-group">
                    <label>M√£ sinh vi√™n:</label>
                    <input type="tel" id="mssv" placeholder="Nh·∫≠p s·ªë..." required pattern="[0-9]*">
                </div>
                <div class="input-group">
                    <label>L·ªõp:</label>
                    <input type="text" id="class_name" placeholder="K68LUAT" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <button type="submit" class="btn-submit" id="btnSub">X√ÅC NH·∫¨N ƒêI·ªÇM DANH</button>
            </form>
        </div>
    </div>

    <!-- N√∫t Reset th√¥ng minh -->
    <div class="reset-container">
        <span class="reset-btn" onclick="smartReset()">üîÑ Reset thi·∫øt b·ªã (ƒêi·ªÉm danh l·∫°i)</span>
    </div>

    <script>
        // ==========================================
        // D√ÅN LINK GOOGLE APPS SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const API_URL = "https://script.google.com/macros/s/AKfycbzzsWZoGnP61ovCHAbG3xlR0TQl-wcMShJHs1JsKaME6y_ymDVE03GUt0Gz2njEGoHL/exec";
        // ==========================================

        const today = new Date().toLocaleDateString('vi-VN');

        // KI·ªÇM TRA CH·∫∂N THI·∫æT B·ªä
        if (localStorage.getItem('attended_today') === today) {
            blockUser("B·∫†N ƒê√É ƒêI·ªÇM DANH R·ªíI!", "M·ªói thi·∫øt b·ªã ch·ªâ ƒë∆∞·ª£c ƒëi·ªÉm danh 1 l·∫ßn/ng√†y.");
        } else {
            checkQRCode();
        }

        // KI·ªÇM TRA M√É QR
        function checkQRCode() {
            const params = new URLSearchParams(window.location.search);
            const qrTime = parseInt(params.get('t'));
            const now = Date.now();

            if (!qrTime || (now - qrTime > 45000)) {
                blockUser("M√É QR ƒê√É H·∫æT H·∫†N!", "M√£ n√†y ƒë√£ c≈©. Vui l√≤ng qu√©t m√£ m·ªõi tr√™n m√†n h√¨nh.");
            }
        }

        function blockUser(title, msg) {
            document.getElementById('formScreen').classList.add('hidden');
            const errDiv = document.getElementById('errorScreen');
            errDiv.classList.remove('hidden');
            document.getElementById('errTitle').innerText = title;
            document.getElementById('errMsg').innerText = msg;
        }

        function formatName(el) {
            let words = el.value.toLowerCase().split(' ');
            for (let i = 0; i < words.length; i++) { words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1); }
            el.value = words.join(' ');
        }

        // --- X·ª¨ L√ù G·ª¨I FORM ---
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSub');
            btn.innerText = "ƒêang g·ª≠i...";
            btn.disabled = true;

            const name = document.getElementById('name').value;
            const mssv = document.getElementById('mssv').value;
            const className = document.getElementById('class_name').value;
            const timeInfo = new Date().toLocaleString('vi-VN');

            // L∆∞u MSSV ƒë·ªÉ d√πng cho t√≠nh nƒÉng Reset th√¥ng minh
            localStorage.setItem('my_mssv', mssv);

            fetch(API_URL, {
                method: "POST",
                // Chuy·ªÉn sang mode cors ƒë·ªÉ ƒë·ªçc ƒë∆∞·ª£c ph·∫£n h·ªìi n·∫øu script h·ªó tr·ª£
                // N·∫øu script ch∆∞a c·∫•u h√¨nh options, d√πng no-cors s·∫Ω kh√¥ng ƒë·ªçc ƒë∆∞·ª£c l·ªói
                // ·ªû ƒë√¢y d√πng no-cors cho an to√†n v·ªõi script c≈©, nh∆∞ng ·ªü t√≠nh nƒÉng Reset ta s·∫Ω d√πng cors
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name, mssv: mssv, class_name: className, device_info: navigator.userAgent })
            }).then(() => {
                localStorage.setItem('attended_today', today);
                Swal.fire({
                    icon: 'success',
                    title: 'TH√ÄNH C√îNG!',
                    html: `<p>SV: <b>${name}</b></p><p>MSSV: <b>${mssv}</b></p><p>L√∫c: <b>${timeInfo}</b></p>`,
                    confirmButtonText: 'OK'
                }).then(() => {
                    blockUser("ƒê√É GHI NH·∫¨N", "C·∫£m ∆°n b·∫°n ƒë√£ tham gia.");
                });
            }).catch(() => {
                Swal.fire('L·ªói', 'L·ªói m·∫°ng ho·∫∑c c·∫•u h√¨nh!', 'error');
                btn.disabled = false;
                btn.innerText = "TH·ª¨ L·∫†I";
            });
        });

        // --- T√çNH NƒÇNG RESET TH√îNG MINH ---
        function smartReset() {
            const mssv = localStorage.getItem('my_mssv');

            // 1. N·∫øu kh√¥ng t√¨m th·∫•y MSSV (do x√≥a cache ho·∫∑c ch∆∞a ƒëi·ªÉm danh) -> H·ªèi Pass
            if (!mssv) {
                askPassword("Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ reset th·ªß c√¥ng:");
                return;
            }

            // 2. N·∫øu c√≥ MSSV -> H·ªèi Server xem c√≤n t·ªìn t·∫°i kh√¥ng
            Swal.fire({
                title: 'ƒêang ki·ªÉm tra...',
                text: 'Vui l√≤ng ch·ªù...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            fetch(API_URL, {
                method: 'POST',
                // Quan tr·ªçng: D√πng redirect: follow ƒë·ªÉ Apps Script tr·∫£ v·ªÅ JSON ƒë·ªçc ƒë∆∞·ª£c
                body: JSON.stringify({ action: "CHECK_STATUS", mssv: mssv })
            })
            .then(res => res.json())
            .then(data => {
                Swal.close();
                if (data.exist === true) {
                    // TR∆Ø·ªúNG H·ª¢P 1: CH∆ØA X√ìA ·ªû DANH S√ÅCH -> C·∫¶N PASS
                    askPassword(`Sinh vi√™n ${mssv} v·∫´n c√≤n trong danh s√°ch ƒëi·ªÉm danh!\nB·∫°n c·∫ßn m·∫≠t kh·∫©u Admin ƒë·ªÉ reset m√°y n√†y.`);
                } else {
                    // TR∆Ø·ªúNG H·ª¢P 2: ƒê√É X√ìA ·ªû DANH S√ÅCH -> KH√îNG C·∫¶N PASS
                    Swal.fire({
                        icon: 'info',
                        title: 'ƒê√£ ƒë∆∞·ª£c ph√©p ƒëi·ªÉm danh l·∫°i!',
                        text: 'Admin ƒë√£ x√≥a d·ªØ li·ªáu c≈© c·ªßa b·∫°n. M√°y s·∫Ω ƒë∆∞·ª£c reset ngay.',
                        confirmButtonText: 'Ti·∫øn h√†nh'
                    }).then(() => {
                        performReset();
                    });
                }
            })
            .catch(err => {
                Swal.close();
                console.error(err);
                // L·ªói m·∫°ng -> Fallback v·ªÅ h·ªèi pass
                askPassword("Kh√¥ng th·ªÉ k·∫øt n·ªëi server ki·ªÉm tra. Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ reset:");
            });
        }

        function askPassword(msg) {
            Swal.fire({
                title: 'Y√™u c·∫ßu quy·ªÅn Admin',
                text: msg,
                input: 'password',
                inputPlaceholder: 'Nh·∫≠p m·∫≠t kh·∫©u Admin',
                showCancelButton: true,
                confirmButtonText: 'M·ªü kh√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (result.value === "Admin") { // Pass m·∫∑c ƒë·ªãnh, c√≥ th·ªÉ ƒë·ªïi
                        performReset();
                    } else {
                        Swal.fire('L·ªói', 'Sai m·∫≠t kh·∫©u!', 'error');
                    }
                }
            });
        }

        function performReset() {
            localStorage.removeItem('attended_today');
            localStorage.removeItem('my_mssv');
            Swal.fire({
                icon: 'success',
                title: 'ƒê√£ Reset!',
                text: 'B·∫°n c√≥ th·ªÉ ƒëi·ªÉm danh l·∫°i ngay b√¢y gi·ªù.',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                location.reload();
            });
        }
    </script>
</body>
</html>
