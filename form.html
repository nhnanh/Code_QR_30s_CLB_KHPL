<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√ÅC NH·∫¨N ƒêI·ªÇM DANH</title>
    <!-- Th∆∞ vi·ªán Popup -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu */
        #name { text-transform: capitalize; }
        /* Vi·∫øt hoa to√†n b·ªô */
        #class_name { text-transform: uppercase; }

        .btn-submit { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; }

        /* M√†n h√¨nh l·ªói */
        .error-screen { text-align: center; padding: 20px; color: #c0392b; background: #fadbd8; border-radius: 10px; border: 2px dashed #c0392b; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- KHUNG ƒêI·ªÇM DANH -->
    <div class="form-card" id="mainContainer">
        <!-- 1. M√†n h√¨nh Form -->
        <div id="formSection">
            <h2>üìã ƒêI·ªÇM DANH</h2>
            <form id="attendanceForm">
                <div class="input-group">
                    <label>H·ªç v√† t√™n:</label>
                    <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required oninput="formatName(this)">
                </div>
                <div class="input-group">
                    <label>M√£ sinh vi√™n:</label>
                    <input type="tel" id="mssv" placeholder="Nh·∫≠p s·ªë..." required pattern="[0-9]*">
                </div>
                <div class="input-group">
                    <label>L·ªõp:</label>
                    <input type="text" id="class_name" placeholder="K68LUAT" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <button type="submit" class="btn-submit" id="btnSub">X√ÅC NH·∫¨N ƒêI·ªÇM DANH</button>
            </form>
        </div>

        <!-- 2. M√†n h√¨nh th√¥ng b√°o l·ªói (·∫®n m·∫∑c ƒë·ªãnh) -->
        <div id="errorSection" class="error-screen hidden">
            <h3 id="errorTitle">‚õî L·ªñI</h3>
            <p id="errorMsg">N·ªôi dung l·ªói</p>
        </div>
    </div>

    <script>
        // ============================================================
        // üëá D√ÅN LINK GOOGLE SCRIPT (EXEC) M·ªöI C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëá
        const API_URL = "https://script.google.com/macros/s/AKfycbw57FoZhAjou0nRXKUgTyA5CY63c-uSVbWWXMahxHXkRxzr2Jhoaon6kwv6AcqjvMvj/exec"; 
        // ============================================================

        const today = new Date().toLocaleDateString('vi-VN');

        // --- 1. CH·∫∂N THI·∫æT B·ªä NGAY L·∫¨P T·ª®C ---
        if (localStorage.getItem('attended_date') === today) {
            showError("B·∫†N ƒê√É ƒêI·ªÇM DANH R·ªíI!", "M·ªói thi·∫øt b·ªã ch·ªâ ƒë∆∞·ª£c ƒëi·ªÉm danh 1 l·∫ßn/ng√†y.");
        } 
        else {
            checkQRCode();
        }

        // --- 2. KI·ªÇM TRA M√É QR (Ch·∫∑n QR c≈©) ---
        function checkQRCode() {
            const params = new URLSearchParams(window.location.search);
            const qrTime = parseInt(params.get('t'));
            const now = Date.now();

            // N·∫øu kh√¥ng c√≥ m√£ t ho·∫∑c m√£ t ƒë√£ qu√° 45 gi√¢y (30s refresh + 15s thao t√°c)
            if (!qrTime || (now - qrTime > 45000)) { 
                showError("M√É QR ƒê√É H·∫æT H·∫†N!", "M√£ n√†y ƒë√£ c≈© ho·∫∑c kh√¥ng h·ª£p l·ªá. Vui l√≤ng qu√©t m√£ m·ªõi tr√™n m√†n h√¨nh.");
            }
        }

        function showError(title, msg) {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('errorTitle').innerText = title;
            document.getElementById('errorMsg').innerText = msg;
        }

        function formatName(el) {
            let words = el.value.toLowerCase().split(' ');
            for (let i = 0; i < words.length; i++) { words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1); }
            el.value = words.join(' ');
        }

        // --- 3. X·ª¨ L√ù G·ª¨I FORM (S·ª¨A L·ªñI POPUP) ---
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnSub');
            btn.innerText = "ƒêang g·ª≠i d·ªØ li·ªáu...";
            btn.disabled = true;

            const name = document.getElementById('name').value;
            const mssv = document.getElementById('mssv').value;
            const className = document.getElementById('class_name').value;
            const timeInfo = new Date().toLocaleString('vi-VN');

            // G·ª≠i d·ªØ li·ªáu ƒëi
            fetch(API_URL, {
                method: "POST",
                mode: "no-cors", // B·∫Øt bu·ªôc ƒë·ªÉ kh√¥ng b·ªã l·ªói b·∫£o m·∫≠t
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: name,
                    mssv: mssv,
                    class_name: className,
                    device_info: navigator.userAgent
                })
            })
            .then(() => {
                // CH·∫ÆC CH·∫ÆN HI·ªÜN POPUP ·ªû ƒê√ÇY
                localStorage.setItem('attended_date', today); // ƒê√°nh d·∫•u ƒë√£ ƒëi·ªÉm danh

                Swal.fire({
                    icon: 'success',
                    title: 'TH√ÄNH C√îNG!',
                    html: `
                        <div style="text-align:left; margin-top:10px">
                            <p><b>Sinh vi√™n:</b> ${name}</p>
                            <p><b>MSSV:</b> ${mssv}</p>
                            <p><b>Th·ªùi gian:</b> ${timeInfo}</p>
                        </div>
                    `,
                    allowOutsideClick: false,
                    confirmButtonText: 'HO√ÄN T·∫§T'
                }).then(() => {
                    // Sau khi b·∫•m Ho√†n t·∫•t -> Ch·∫∑n m√†n h√¨nh
                    showError("ƒê√É GHI NH·∫¨N", "C·∫£m ∆°n b·∫°n ƒë√£ tham gia bu·ªïi h·ªçc.");
                });
            })
            .catch(err => {
                Swal.fire('L·ªói m·∫°ng', 'Vui l√≤ng ki·ªÉm tra internet v√† th·ª≠ l·∫°i', 'error');
                btn.disabled = false;
                btn.innerText = "TH·ª¨ L·∫†I";
            });
        });
    </script>
</body>
</html>
