<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√ÅC NH·∫¨N ƒêI·ªÇM DANH</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        #name { text-transform: capitalize; }
        #class_name { text-transform: uppercase; }

        .btn-submit { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-submit:hover { background: #27ae60; }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; }

        .hidden { display: none; }
        .blocked-msg { text-align: center; color: #c0392b; font-weight: bold; padding: 20px; border: 2px dashed #c0392b; border-radius: 10px; background: #fadbd8; }
    </style>
</head>
<body>

    <div class="form-card">
        <div id="blockedScreen" class="hidden">
            <div class="blocked-msg">
                <h3 id="blockTitle">‚õî M√É QR ƒê√É H·∫æT H·∫†N!</h3>
                <p id="blockReason">Vui l√≤ng qu√©t m√£ m·ªõi tr√™n m√†n h√¨nh.</p>
            </div>
        </div>

        <div id="formScreen">
            <h2>üìã ƒêI·ªÇM DANH</h2>
            <form id="attendanceForm">
                <div class="input-group">
                    <label>H·ªç v√† t√™n:</label>
                    <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required oninput="formatName(this)">
                </div>
                <div class="input-group">
                    <label>M√£ sinh vi√™n:</label>
                    <input type="tel" id="mssv" placeholder="Nh·∫≠p s·ªë..." required pattern="[0-9]*">
                </div>
                <div class="input-group">
                    <label>L·ªõp:</label>
                    <input type="text" id="class_name" placeholder="K68LUAT" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <button type="submit" class="btn-submit" id="btnSub">X√ÅC NH·∫¨N</button>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        // THAY LINK M·ªöI C·ª¶A B·∫†N V√ÄO ƒê√ÇY (Link Apps Script /exec)
        const API_URL = https://script.google.com/macros/s/AKfycbw1oa6F1uhF6ye-JGKLMTxBrArYS49Wfxc5Hy6-ZNBuASWoNlGT9UFpNYL39zN3BnHN/exec; 
        // ==========================================

        // 1. KI·ªÇM TRA CH·∫∂N THI·∫æT B·ªä (1 l·∫ßn/ng√†y)
        const today = new Date().toLocaleDateString('vi-VN');
        if (localStorage.getItem('attended_today') === today) {
            blockScreen("‚õî B·∫†N ƒê√É ƒêI·ªÇM DANH R·ªíI!", "M·ªói thi·∫øt b·ªã ch·ªâ ƒë∆∞·ª£c ƒëi·ªÉm danh 1 l·∫ßn/ng√†y.");
        }

        // 2. KI·ªÇM TRA M√É QR (Logic ch·∫∑t ch·∫Ω h∆°n)
        const urlParams = new URLSearchParams(window.location.search);
        const qrTimeStr = urlParams.get('t');
        
        // N·∫øu kh√¥ng c√≥ tham s·ªë t -> Ch·∫∑n lu√¥n (ƒë·ªÅ ph√≤ng v√†o link tr·ª±c ti·∫øp)
        if (!qrTimeStr) {
            blockScreen("‚õî L·ªñI TRUY C·∫¨P", "Vui l√≤ng qu√©t m√£ QR ƒë·ªÉ truy c·∫≠p.");
        } else {
            const qrTime = parseInt(qrTimeStr);
            const now = Date.now();
            // Cho ph√©p tr·ªÖ t·ªëi ƒëa 45 gi√¢y
            if (now - qrTime > 45000) { 
                blockScreen("‚õî M√É QR ƒê√É H·∫æT H·∫†N!", "M√£ n√†y ƒë√£ c≈©. Vui l√≤ng qu√©t m√£ m·ªõi.");
            }
        }

        function formatName(el) {
            let words = el.value.toLowerCase().split(' ');
            for (let i = 0; i < words.length; i++) { words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1); }
            el.value = words.join(' ');
        }

        function blockScreen(title, reason) {
            document.getElementById('formScreen').remove(); // X√≥a h·∫≥n form kh·ªèi DOM
            document.getElementById('blockedScreen').classList.remove('hidden');
            document.getElementById('blockTitle').innerText = title;
            document.getElementById('blockReason').innerText = reason;
        }

        // 3. X·ª¨ L√ù G·ª¨I FORM (S·ª≠ d·ª•ng sendBeacon ho·∫∑c fetch no-cors c·∫£i ti·∫øn)
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnSub');
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;

            const name = document.getElementById('name').value;
            const mssv = document.getElementById('mssv').value;
            const className = document.getElementById('class_name').value;
            const timeReal = new Date().toLocaleString('vi-VN');

            // K·ªπ thu·∫≠t m·ªõi: Gi·∫£ l·∫≠p g·ª≠i th√†nh c√¥ng v√¨ no-cors kh√¥ng tr·∫£ v·ªÅ k·∫øt qu·∫£
            // Ch√∫ng ta s·∫Ω hi·ªÉn th·ªã popup ngay sau khi g·ª≠i l·ªánh, v√¨ Google Script r·∫•t hi·∫øm khi l·ªói n·∫øu ƒë√£ c·∫•u h√¨nh ƒë√∫ng.
            
            fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    name: name, 
                    mssv: mssv, 
                    class_name: className, 
                    device_info: navigator.userAgent 
                })
            }).then(() => {
                // M·∫∑c ƒë·ªãnh coi nh∆∞ th√†nh c√¥ng v√¨ no-cors kh√¥ng b√°o l·ªói
                localStorage.setItem('attended_today', today);
                
                Swal.fire({
                    icon: 'success',
                    title: 'ƒêI·ªÇM DANH TH√ÄNH C√îNG!',
                    html: `
                        <div style="text-align: left; margin-top: 10px;">
                            <p><b>H·ªá th·ªëng ƒë√£ ghi nh·∫≠n:</b></p>
                            <p>üë®‚Äçüéì SV: <b>${name}</b></p>
                            <p>üÜî MSSV: <b>${mssv}</b></p>
                            <p>‚è∞ L√∫c: <b>${timeReal}</b></p>
                        </div>
                    `,
                    confirmButtonText: 'HO√ÄN T·∫§T',
                    allowOutsideClick: false
                }).then(() => {
                    blockScreen("‚úÖ ƒê√É GHI NH·∫¨N", "B·∫°n ƒë√£ ƒëi·ªÉm danh th√†nh c√¥ng h√¥m nay.");
                });
            }).catch(err => {
                // Ch·ªâ b·∫Øt l·ªói m·∫°ng (m·∫•t net)
                Swal.fire('L·ªói ƒë∆∞·ªùng truy·ªÅn', 'Vui l√≤ng ki·ªÉm tra Wifi/4G v√† th·ª≠ l·∫°i', 'error');
                btn.disabled = false;
                btn.innerText = "X√ÅC NH·∫¨N";
            });
        });
    </script>
</body>
</html>
