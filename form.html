<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√ÅC NH·∫¨N ƒêI·ªÇM DANH</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; position: relative; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        #name { text-transform: capitalize; }
        #class_name { text-transform: uppercase; }

        .btn-submit { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; }

        .hidden { display: none !important; }
        .error-screen { text-align: center; color: #c0392b; background: #fadbd8; padding: 20px; border-radius: 10px; border: 2px dashed #c0392b; }
        
        /* N√∫t Reset ·∫©n d∆∞·ªõi c√πng */
        .reset-btn { position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: #ccc; cursor: pointer; text-decoration: none; }
        .reset-btn:hover { color: #555; }
    </style>
</head>
<body>

    <div class="form-card">
        <!-- 1. M√†n h√¨nh l·ªói / Ch·∫∑n -->
        <div id="errorScreen" class="hidden error-screen">
            <h3 id="errTitle">‚õî L·ªñI</h3>
            <p id="errMsg">N·ªôi dung l·ªói</p>
        </div>

        <!-- 2. M√†n h√¨nh Form -->
        <div id="formScreen">
            <h2>üìã ƒêI·ªÇM DANH</h2>
            <form id="attendanceForm">
                <div class="input-group">
                    <label>H·ªç v√† t√™n:</label>
                    <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required oninput="formatName(this)">
                </div>
                <div class="input-group">
                    <label>M√£ sinh vi√™n:</label>
                    <input type="tel" id="mssv" placeholder="Nh·∫≠p s·ªë..." required pattern="[0-9]*">
                </div>
                <div class="input-group">
                    <label>L·ªõp:</label>
                    <input type="text" id="class_name" placeholder="K68LUAT" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <button type="submit" class="btn-submit" id="btnSub">X√ÅC NH·∫¨N ƒêI·ªÇM DANH</button>
            </form>
        </div>
    </div>

    <!-- N√∫t Reset cho ph√©p ƒëi·ªÉm danh l·∫°i -->
    <div class="reset-btn" onclick="resetDevice()">üîÑ Reset thi·∫øt b·ªã</div>

    <script>
        // ==========================================
        // D√ÅN LINK GOOGLE APPS SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const API_URL = "https://script.google.com/macros/s/AKfycbygMe9R513GKxsNNQq7tM0VNqTVFbeFDFernitxU5bWezIlf821_f-eiycZvZWi4_Bn/exec";
        // ==========================================

        const today = new Date().toLocaleDateString('vi-VN');

        // KI·ªÇM TRA CH·∫∂N THI·∫æT B·ªä
        if (localStorage.getItem('attended_today') === today) {
            blockUser("B·∫†N ƒê√É ƒêI·ªÇM DANH R·ªíI!", "M·ªói thi·∫øt b·ªã ch·ªâ ƒë∆∞·ª£c ƒëi·ªÉm danh 1 l·∫ßn/ng√†y.");
        } else {
            checkQRCode();
        }

        // KI·ªÇM TRA M√É QR (Ch·∫∑t ch·∫Ω h∆°n)
        function checkQRCode() {
            const params = new URLSearchParams(window.location.search);
            const qrTime = parseInt(params.get('t'));
            const now = Date.now();

            // N·∫øu QR c≈© qu√° 45 gi√¢y (30s refresh + 15s thao t√°c) -> CH·∫∂N
            if (!qrTime || (now - qrTime > 45000)) {
                blockUser("M√É QR ƒê√É H·∫æT H·∫†N!", "M√£ n√†y ƒë√£ c≈©. Vui l√≤ng qu√©t m√£ m·ªõi tr√™n m√†n h√¨nh.");
            }
        }

        function blockUser(title, msg) {
            document.getElementById('formScreen').classList.add('hidden');
            const errDiv = document.getElementById('errorScreen');
            errDiv.classList.remove('hidden');
            document.getElementById('errTitle').innerText = title;
            document.getElementById('errMsg').innerText = msg;
        }

        function formatName(el) {
            let words = el.value.toLowerCase().split(' ');
            for (let i = 0; i < words.length; i++) { words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1); }
            el.value = words.join(' ');
        }

        // X·ª¨ L√ù G·ª¨I FORM
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSub');
            btn.innerText = "ƒêang g·ª≠i...";
            btn.disabled = true;

            const name = document.getElementById('name').value;
            const mssv = document.getElementById('mssv').value;
            const className = document.getElementById('class_name').value;
            const timeInfo = new Date().toLocaleString('vi-VN');

            fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name, mssv: mssv, class_name: className, device_info: navigator.userAgent })
            }).then(() => {
                localStorage.setItem('attended_today', today);
                Swal.fire({
                    icon: 'success',
                    title: 'TH√ÄNH C√îNG!',
                    html: `<p>SV: <b>${name}</b></p><p>MSSV: <b>${mssv}</b></p><p>L√∫c: <b>${timeInfo}</b></p>`,
                    confirmButtonText: 'OK'
                }).then(() => {
                    blockUser("ƒê√É GHI NH·∫¨N", "C·∫£m ∆°n b·∫°n ƒë√£ tham gia.");
                });
            }).catch(() => {
                Swal.fire('L·ªói', 'L·ªói m·∫°ng!', 'error');
                btn.disabled = false;
                btn.innerText = "TH·ª¨ L·∫†I";
            });
        });

        // T√çNH NƒÇNG RESET (Cho ph√©p ƒëi·ªÉm danh l·∫°i tr√™n thi·∫øt b·ªã n√†y)
        function resetDevice() {
            let p = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ reset thi·∫øt b·ªã n√†y:");
            if (p === "Admin") { // B·∫°n c√≥ th·ªÉ ƒë·ªïi pass n√†y
                localStorage.removeItem('attended_today');
                alert("ƒê√£ reset! C√≥ th·ªÉ ƒëi·ªÉm danh l·∫°i.");
                location.reload();
            } else if (p !== null) {
                alert("Sai m·∫≠t kh·∫©u!");
            }
        }
    </script>
</body>
</html>
