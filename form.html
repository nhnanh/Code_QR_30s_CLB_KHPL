<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√ÅC NH·∫¨N ƒêI·ªÇM DANH</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; position: relative; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        #name { text-transform: capitalize; }
        #class_name { text-transform: uppercase; }
        .btn-submit { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-submit:hover { background: #27ae60; }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; }
        .hidden { display: none !important; }
        .error-screen { text-align: center; color: #c0392b; background: #fadbd8; padding: 20px; border-radius: 10px; border: 2px dashed #c0392b; }
        .reset-container { position: absolute; bottom: 10px; width: 100%; text-align: center; }
        .reset-btn { font-size: 12px; color: #999; cursor: pointer; text-decoration: none; padding: 5px; }
        .reset-btn:hover { color: #555; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="form-card">
        <div id="errorScreen" class="hidden error-screen">
            <h3 id="errTitle">‚õî L·ªñI</h3>
            <p id="errMsg">N·ªôi dung l·ªói</p>
        </div>
        <div id="formScreen">
            <h2>üìã ƒêI·ªÇM DANH</h2>
            <form id="attendanceForm">
                <div class="input-group">
                    <label>H·ªç v√† t√™n:</label>
                    <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required oninput="formatName(this)">
                </div>
                <div class="input-group">
                    <label>M√£ sinh vi√™n:</label>
                    <input type="tel" id="mssv" placeholder="Nh·∫≠p s·ªë..." required pattern="[0-9]*">
                </div>
                <div class="input-group">
                    <label>L·ªõp:</label>
                    <input type="text" id="class_name" placeholder="K68LUAT" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <button type="submit" class="btn-submit" id="btnSub">X√ÅC NH·∫¨N ƒêI·ªÇM DANH</button>
            </form>
        </div>
    </div>
    <div class="reset-container">
        <span class="reset-btn" onclick="smartReset()">üîÑ Reset thi·∫øt b·ªã (ƒêi·ªÉm danh l·∫°i)</span>
    </div>

    <script>
        // --- C·∫§U H√åNH API ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyvd6O04qlB3sLr-jMb9Vj1aixd_9ZAcBqF-EgFCkY4oOU7dvvye7xmDNIuEUO5FJjm/exec";
        const today = new Date().toLocaleDateString('vi-VN');

        if (localStorage.getItem('attended_today') === today) {
            blockUser("B·∫†N ƒê√É ƒêI·ªÇM DANH R·ªíI!", "M·ªói thi·∫øt b·ªã ch·ªâ ƒë∆∞·ª£c ƒëi·ªÉm danh 1 l·∫ßn/ng√†y.");
        } else {
            checkQRCode();
        }

        function checkQRCode() {
            const params = new URLSearchParams(window.location.search);
            const qrTime = parseInt(params.get('t'));
            const now = Date.now();
            if (!qrTime || (now - qrTime > 45000)) {
                blockUser("M√É QR ƒê√É H·∫æT H·∫†N!", "M√£ n√†y ƒë√£ c≈©. Vui l√≤ng qu√©t m√£ m·ªõi tr√™n m√†n h√¨nh.");
            }
        }

        function blockUser(title, msg) {
            document.getElementById('formScreen').classList.add('hidden');
            const errDiv = document.getElementById('errorScreen');
            errDiv.classList.remove('hidden');
            document.getElementById('errTitle').innerText = title;
            document.getElementById('errMsg').innerText = msg;
        }

        function formatName(el) {
            let words = el.value.toLowerCase().split(' ');
            for (let i = 0; i < words.length; i++) { words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1); }
            el.value = words.join(' ');
        }

        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSub');
            btn.innerText = "ƒêang g·ª≠i...";
            btn.disabled = true;
            const name = document.getElementById('name').value;
            const mssv = document.getElementById('mssv').value;
            const className = document.getElementById('class_name').value;
            const timeInfo = new Date().toLocaleString('vi-VN');
            
            localStorage.setItem('my_mssv', mssv); // L∆∞u MSSV ƒë·ªÉ d√πng cho reset sau n√†y

            fetch(API_URL, {
                method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name, mssv: mssv, class_name: className, device_info: navigator.userAgent })
            }).then(() => {
                localStorage.setItem('attended_today', today);
                Swal.fire({
                    icon: 'success', title: 'TH√ÄNH C√îNG!',
                    html: `<p>SV: <b>${name}</b></p><p>MSSV: <b>${mssv}</b></p><p>L√∫c: <b>${timeInfo}</b></p>`,
                    confirmButtonText: 'OK'
                }).then(() => { blockUser("ƒê√É GHI NH·∫¨N", "C·∫£m ∆°n b·∫°n ƒë√£ tham gia."); });
            }).catch(() => {
                Swal.fire('L·ªói', 'L·ªói m·∫°ng ho·∫∑c c·∫•u h√¨nh!', 'error');
                btn.disabled = false; btn.innerText = "TH·ª¨ L·∫†I";
            });
        });

        // --- T√çNH NƒÇNG RESET TH√îNG MINH ---
        function smartReset() {
            const mssv = localStorage.getItem('my_mssv');

            // Tr∆∞·ªùng h·ª£p 1: Ch∆∞a c√≥ MSSV (ch∆∞a ƒëi·ªÉm danh l·∫ßn n√†o) -> H·ªèi Pass Admin
            if (!mssv) {
                askPassword("Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ reset th·ªß c√¥ng:");
                return;
            }

            Swal.fire({ title: 'ƒêang ki·ªÉm tra...', didOpen: () => Swal.showLoading() });

            // G·ª≠i y√™u c·∫ßu ki·ªÉm tra tr·∫°ng th√°i
            fetch(API_URL, {
                method: 'POST',
                // redirect: 'follow' quan tr·ªçng ƒë·ªÉ ƒë·ªçc response JSON t·ª´ Apps Script
                body: JSON.stringify({ action: "CHECK_STATUS", mssv: mssv })
            })
            .then(res => res.json())
            .then(data => {
                Swal.close();
                if (data.exist === true) {
                    // TR∆Ø·ªúNG H·ª¢P 2: C√ì T√äN TRONG DANH S√ÅCH -> NH·∫¨P L√ù DO
                    askReason(mssv, data.name, data.class_name);
                } else {
                    // TR∆Ø·ªúNG H·ª¢P 3: ƒê√É B·ªä X√ìA -> RESET LU√îN
                    performReset();
                }
            })
            .catch(err => {
                Swal.close();
                // L·ªói m·∫°ng/API -> Fallback h·ªèi pass
                askPassword("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server. Nh·∫≠p m·∫≠t kh·∫©u Admin:");
            });
        }

        function askReason(mssv, name, className) {
            Swal.fire({
                title: 'Y√äU C·∫¶U ƒêI·ªÇM DANH L·∫†I',
                html: `<p style="font-size:14px; color:#555">B·∫°n <b>${name}</b> (${mssv}) ƒë√£ c√≥ t√™n trong danh s√°ch.<br>Vui l√≤ng nh·∫≠p l√Ω do ƒë·ªÉ Admin ph√™ duy·ªát reset.</p>`,
                input: 'textarea',
                inputPlaceholder: 'Nh·∫≠p l√Ω do (VD: ƒêi·ªÅn sai l·ªõp, m∆∞·ª£n m√°y b·∫°n...)',
                showCancelButton: true,
                confirmButtonText: 'G·ª≠i Y√™u C·∫ßu & Reset'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    // G·ª≠i y√™u c·∫ßu l√™n server
                    fetch(API_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            action: "REQUEST_RESET", 
                            mssv: mssv, name: name || "Unknown", class_name: className || "Unknown", 
                            reason: result.value 
                        })
                    }).then(() => {
                        Swal.fire('ƒê√£ g·ª≠i!', 'Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c g·ª≠i. M√°y s·∫Ω reset ngay.', 'success')
                        .then(() => { performReset(); });
                    });
                }
            });
        }

        function askPassword(msg) {
            const adminPass = localStorage.getItem('admin_reset_pass') || "Admin"; // L·∫•y pass t·ª´ b·ªô nh·ªõ n·∫øu chung domain
            Swal.fire({
                title: 'M·ªü Kh√≥a Thi·∫øt B·ªã', text: msg, input: 'password', showCancelButton: true
            }).then((result) => {
                if (result.value === adminPass) performReset();
                else if (result.isConfirmed) Swal.fire('L·ªói', 'Sai m·∫≠t kh·∫©u!', 'error');
            });
        }

        function performReset() {
            localStorage.removeItem('attended_today');
            localStorage.removeItem('my_mssv');
            location.reload();
        }
    </script>
</body>
</html>
