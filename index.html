<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QU·∫¢N TR·ªä ƒêI·ªÇM DANH PRO MAX</title>
    
    <!-- Th∆∞ vi·ªán -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; --primary-light: #818cf8; --bg: #f3f4f6; --text: #1e293b;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --white: #ffffff;
            --border: #e2e8f0; --glass: rgba(255, 255, 255, 0.9);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
        }
        body.dark-mode { 
            --primary: #818cf8; --bg: #0f172a; --text: #f1f5f9; --white: #1e293b; 
            --border: #334155; --glass: rgba(30, 41, 59, 0.9);
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; transition: background 0.3s; }
        * { box-sizing: border-box; }
        
        /* --- 1. QR SECTION (GIAO DI·ªÜN M·ªöI) --- */
        #qrSection { 
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; z-index: 1; transition: all 0.3s ease; 
        }

        .qr-card { 
            position: relative; background: var(--white); padding: 40px; border-radius: 30px; 
            box-shadow: var(--shadow); text-align: center; width: 400px; max-width: 90%; 
            display: flex; flex-direction: column; align-items: center; z-index: 2;
        }

        /* Hi·ªáu ·ª©ng vi·ªÅn ch·∫°y (Running Border) */
        .qr-card::before {
            content: ''; position: absolute; inset: -4px; border-radius: 34px; 
            background: conic-gradient(from 0deg, transparent 70%, var(--primary));
            animation: rotate 4s linear infinite; z-index: -1;
        }
        .qr-card::after {
            content: ''; position: absolute; inset: 2px; background: var(--white); 
            border-radius: 28px; z-index: -1;
        }
        body.dark-mode .qr-card::after { background: var(--white); } /* Gi·ªØ m√†u n·ªÅn card theo theme */

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #orgName { 
            font-size: 24px; font-weight: 800; text-transform: uppercase; 
            background: linear-gradient(to right, var(--primary), #9333ea); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px;
        }
        
        #qrcode { padding: 15px; background: white; border-radius: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .timer-box { display: flex; flex-direction: column; align-items: center; }
        .timer { font-family: 'JetBrains Mono', monospace; font-size: 48px; color: var(--danger); line-height: 1; }
        .timer-label { font-size: 12px; color: #94a3b8; margin-top: 5px; text-transform: uppercase; }

        /* --- 2. ADMIN SECTION --- */
        #adminSection { 
            display: none; flex-direction: column; background: var(--white); 
            border-left: 1px solid var(--border); width: 50%; min-width: 500px;
            position: relative; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.05);
        }
        
        /* Split Screen Logic */
        body.admin-open #adminSection { display: flex; }
        body.admin-open #qrSection { width: 50%; flex: none; }
        body.admin-open .settings-btn { display: none; }
        
        /* Mobile & Fullscreen */
        @media (max-width: 1024px) {
            body.admin-open #adminSection { width: 100%; position: absolute; left: 0; top: 0; }
            body.admin-open #qrSection { display: none; }
        }

        /* --- UI COMPONENTS --- */
        .settings-btn { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; padding: 10px; z-index: 50; background: var(--white); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .settings-btn:hover { color: var(--primary); transform: rotate(90deg); }

        .admin-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .admin-body { padding: 20px; overflow-y: auto; flex: 1; background: var(--bg); }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 16px; border: 1px solid transparent; background: var(--white); border-radius: 20px; font-weight: 600; color: #64748b; cursor: pointer; transition: 0.2s; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Form & Inputs */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: var(--text); }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: var(--white); color: var(--text); transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        input[readonly] { background: #f1f5f9; cursor: not-allowed; border-style: dashed; }
        input.unlocked { background: #ecfdf5; border-color: var(--success); color: var(--success); font-weight: bold; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-gray { background: #64748b; }

        /* --- DASHBOARD CHARTS --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; border: 1px solid var(--border); }
        .stat-num { font-size: 28px; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .stat-label { font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; }
        
        .chart-box { background: var(--white); padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; }

        /* --- TABLE & FILTER --- */
        .excel-container { background: var(--white); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .excel-toolbar { padding: 15px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; gap: 10px; flex-wrap: wrap; }
        .excel-table-wrap { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; font-weight: 700; color: #475569; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; white-space: nowrap; color: var(--text); }
        tr:hover td { background: #f8fafc; }
        
        .bell-cell { text-align: center; }
        .bell-btn { color: #cbd5e1; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .bell-btn.active { color: var(--danger); animation: swing 0.8s infinite; }
        @keyframes swing { 20% {transform: rotate(15deg);} 40% {transform: rotate(-10deg);} 60% {transform: rotate(5deg);} 80% {transform: rotate(-5deg);} }

        /* --- FORM BUILDER (CARD STYLE) --- */
        .fb-item { background: var(--white); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; border-left: 4px solid var(--primary); }
        .fb-settings { flex: 1; display: grid; grid-template-columns: 2fr 2fr 1fr 1fr 1fr auto; gap: 10px; }

        /* --- TIMELINE LOG --- */
        .timeline { list-style: none; padding: 0 0 0 20px; border-left: 2px solid #e2e8f0; margin: 10px 0 0 10px; }
        .timeline-item { margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -26px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: var(--white); border: 2px solid var(--primary); }
        .timeline-item.warning::before { border-color: var(--warning); background: #fff7ed; }
        .timeline-item.success::before { border-color: var(--success); background: #f0fdf4; }
        .log-card { background: var(--white); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border); }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; color: #64748b; }
        .log-content { font-size: 14px; font-weight: 500; }

        /* --- TOOLS GRID --- */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .tool-card { background: var(--white); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px; height: 120px; justify-content: center; }
        .tool-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .tool-card i { font-size: 28px; color: var(--primary); margin-bottom: 5px; }
        .tool-active { background: #eff6ff; border-color: var(--primary); }

        /* --- TOASTS & MODALS --- */
        #liveToastContainer { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column-reverse; gap: 10px; pointer-events: none; }
        .live-toast { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border-left: 5px solid var(--success); box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 320px; pointer-events: auto; animation: slideIn 0.3s ease; display: flex; gap: 12px; align-items: flex-start; }
        .live-toast.warning { border-left-color: var(--warning); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

        #reqModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .req-content { background: var(--white); width: 400px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        #authModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 40px; border-radius: 24px; text-align: center; width: 320px; }
        
        #qrZoomModal { display: none; position: fixed; inset: 0; background: white; z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- N√∫t M·ªü Admin -->
    <div class="settings-btn" onclick="openAuth()"><i class="fa-solid fa-sliders"></i></div>
    <div id="liveToastContainer"></div>

    <!-- M√ÄN H√åNH QR -->
    <div id="qrSection">
        <div class="qr-card">
            <h1 id="orgName">ƒêI·ªÇM DANH CLB</h1>
            <div id="qrcode"></div>
            <div class="timer-box">
                <div class="timer" id="countdown">--</div>
                <div class="timer-label">L√†m m·ªõi sau</div>
            </div>
            <div class="realtime"><i class="fa-regular fa-clock"></i> <span id="clock">...</span></div>
        </div>
        <div id="marqueeContainer" style="position:fixed; bottom:0; width:100%; background:var(--danger); color:white; padding:10px; font-weight:bold; display:none;">
            <marquee id="marqueeText"></marquee>
        </div>
    </div>

    <!-- M√ÄN H√åNH ADMIN -->
    <div id="adminSection">
        <div class="admin-header">
            <div class="admin-title"><i class="fa-solid fa-shield-halved"></i> QU·∫¢N TR·ªä VI√äN</div>
            <div style="display:flex; gap:10px">
                <button class="btn btn-gray" onclick="toggleFullAdmin()"><i class="fa-solid fa-expand"></i></button>
                <button class="btn btn-danger" onclick="closeAdmin()">Tho√°t</button>
            </div>
        </div>

        <div class="admin-body">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('tab-stats')">Th·ªëng K√™</button>
                <button class="tab-btn" onclick="switchTab('tab-data')">Danh S√°ch</button>
                <button class="tab-btn" onclick="switchTab('tab-form')">C·∫•u h√¨nh Form</button>
                <button class="tab-btn" onclick="switchTab('tab-log')">L·ªãch s·ª≠ & TB</button>
                <button class="tab-btn" onclick="switchTab('tab-tools')">Ti·ªán √çch</button>
                <button class="tab-btn" onclick="switchTab('tab-config')">C√†i ƒê·∫∑t</button>
            </div>

            <!-- 1. TH·ªêNG K√ä -->
            <div id="tab-stats" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-num" id="statTotal">0</span><span class="stat-label">T·ªïng Sinh Vi√™n</span></div>
                    <div class="stat-card"><span class="stat-num" id="statClasses" style="color:var(--success)">0</span><span class="stat-label">L·ªõp Tham Gia</span></div>
                    <div class="stat-card"><span class="stat-num" id="statReq" style="color:var(--warning)">0</span><span class="stat-label">Y√™u C·∫ßu M·ªõi</span></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div class="chart-box"><canvas id="classChart"></canvas></div>
                    <div class="chart-box"><canvas id="timeChart"></canvas></div>
                </div>
                <div class="chart-box" style="height:250px"><canvas id="lineChart"></canvas></div>
            </div>

            <!-- 2. DANH S√ÅCH & Y√äU C·∫¶U -->
            <div id="tab-data" class="tab-content">
                <div class="excel-container">
                    <div class="excel-toolbar">
                        <input type="date" id="viewDate" onchange="fetchList()" style="width:auto">
                        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm..." onkeyup="applyFilter()" style="flex:1">
                        <button class="btn btn-primary" onclick="fetchList()"><i class="fa-solid fa-rotate"></i> T·∫£i l·∫°i</button>
                    </div>
                    <div class="excel-table-container">
                        <table id="dataTable">
                            <thead><tr id="dynamicHeader"></tr></thead>
                            <tbody id="tableBody"><tr><td colspan="10" style="text-align:center; padding:30px">ƒêang t·∫£i...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. C·∫§U H√åNH FORM -->
            <div id="tab-form" class="tab-content">
                <div class="form-group"><label>Ti√™u ƒë·ªÅ Form:</label><input type="text" id="fbTitle" value="TH√îNG TIN SINH VI√äN"></div>
                <div class="fb-container" id="fbFields"></div>
                <button class="btn btn-gray" onclick="addFormField()" style="width:100%; margin-top:15px; border-style:dashed">+ Th√™m tr∆∞·ªùng</button>
                <div style="margin-top:20px; text-align:right">
                    <button class="btn btn-success" onclick="saveFormConfig()"><i class="fa-solid fa-cloud-arrow-up"></i> L∆∞u Form l√™n Server</button>
                </div>
            </div>

            <!-- 4. L·ªäCH S·ª¨ LOG -->
            <div id="tab-log" class="tab-content">
                <div style="text-align:right; margin-bottom:10px"><button class="btn btn-gray" onclick="clearLocalLogs()">X√≥a l·ªãch s·ª≠</button></div>
                <ul id="logList" class="timeline"></ul>
            </div>

            <!-- 5. TI·ªÜN √çCH -->
            <div id="tab-tools" class="tab-content">
                <div class="tools-grid">
                    <div class="tool-card" id="toolLive" onclick="toggleLiveNotif()"><i class="fa-solid fa-bell"></i><span>TB Live</span></div>
                    <div class="tool-card" id="toolPause" onclick="togglePause()"><i class="fa-solid fa-pause"></i><span>T·∫°m d·ª´ng</span></div>
                    <div class="tool-card" id="toolDark" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i><span>Giao di·ªán</span></div>
                    <div class="tool-card" onclick="downloadQR()"><i class="fa-solid fa-download"></i><span>T·∫£i QR</span></div>
                    <div class="tool-card" onclick="exportCSV()"><i class="fa-solid fa-file-csv"></i><span>Xu·∫•t Excel</span></div>
                    <div class="tool-card" onclick="zoomQR()"><i class="fa-solid fa-magnifying-glass-plus"></i><span>Ph√≥ng to QR</span></div>
                    <div class="tool-card" onclick="openFormLink()"><i class="fa-solid fa-link"></i><span>Link Form</span></div>
                    <div class="tool-card" onclick="window.location.reload()"><i class="fa-solid fa-rotate"></i><span>Reload</span></div>
                </div>
            </div>

            <!-- 6. C√ÄI ƒê·∫∂T -->
            <div id="tab-config" class="tab-content">
                <div class="form-group"><label>API Google Script:</label>
                    <div style="position:relative"><input type="text" id="cfgApi" readonly style="background:#f1f5f9; padding-right:40px"><i class="fa-solid fa-lock" style="position:absolute; right:10px; top:12px; color:#999; cursor:pointer" onclick="unlockField('cfgApi')"></i></div>
                </div>
                <div class="form-group"><label>Link Form:</label><input type="text" id="cfgLink"></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px">
                    <div class="form-group"><label>Pass Admin:</label><input type="password" id="cfgPass" readonly style="background:#f1f5f9" onclick="unlockField('cfgPass')"></div>
                    <div class="form-group"><label>Pass Reset:</label><input type="password" id="cfgReset" readonly style="background:#f1f5f9" onclick="unlockField('cfgReset')"></div>
                    <div class="form-group"><label>Th·ªùi gian QR:</label><input type="number" id="cfgTime"></div>
                </div>

                <div style="border:1px solid #eee; padding:15px; border-radius:10px; margin-top:10px">
                    <label>Giao di·ªán & Th√¥ng b√°o</label>
                    <div style="display:flex; gap:10px; margin-top:10px">
                        <input type="color" id="cfgQrColor" style="height:40px; flex:1">
                        <input type="text" id="cfgMqText" placeholder="Ch·ªØ ch·∫°y..." style="flex:3">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSystemConfig()" style="width:100%; margin-top:20px; padding:15px">L∆ØU C√ÄI ƒê·∫∂T</button>
            </div>
        </div>
    </div>

    <!-- MODAL DUY·ªÜT Y√äU C·∫¶U -->
    <div id="reqModal">
        <div class="req-content">
            <h3 style="color:var(--primary); margin-top:0"><i class="fa-solid fa-user-shield"></i> DUY·ªÜT Y√äU C·∫¶U RESET</h3>
            <div id="reqInfo" style="text-align:left; margin:20px 0; background:#f8fafc; padding:15px; border-radius:10px;"></div>
            <div style="display:flex; gap:10px; justify-content:center">
                <button class="btn btn-gray" onclick="closeReqModal()">ƒê√≥ng</button>
                <button class="btn btn-danger" onclick="rejectReq()">T·ª´ ch·ªëi</button>
                <button class="btn btn-success" onclick="approveReq()">Ch·∫•p thu·∫≠n (X√≥a)</button>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="authModal">
        <div class="auth-box">
            <h3>ƒêƒÇNG NH·∫¨P</h3>
            <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:15px; text-align:center; font-size:18px; letter-spacing:5px; margin:20px 0; border:1px solid #ddd; border-radius:10px;">
            <button class="btn btn-primary" onclick="doLogin()" style="width:100%; padding:15px">V√ÄO ADMIN</button>
        </div>
    </div>

    <!-- ZOOM QR -->
    <div id="qrZoomModal"><h2 style="color:var(--text)">QU√âT M√É ƒêI·ªÇM DANH</h2><div id="qrcodeZoom" style="transform: scale(1.5); margin: 50px;"></div><button class="btn btn-danger" onclick="document.getElementById('qrZoomModal').style.display='none'">ƒê√≥ng</button></div>

    <script>
        const DEFAULT = { api: "https://script.google.com/macros/s/AKfycbxQgOytzD2nJwoCSdTLiRaGnl567gcNKVOmHTsA_u8dJ7Y87rBBFlJc1c32uuYLtauy/exec", pass: "Admin", reset: "Admin", title: "ƒêI·ªÇM DANH CLB", time: 30, mqText: "H·ªÜ TH·ªêNG ƒêANG M·ªû", qrColor: "#000000", notifEnabled: true };
        let cfg = JSON.parse(localStorage.getItem('qr_cfg')) || DEFAULT;
        let formCfg = { title: "TH√îNG TIN", fields: [{label:"H·ªç T√™n", type:"text", required:true}, {label:"MSSV", type:"tel", required:true}, {label:"L·ªõp", type:"text", required:true}] };
        let allData = [], filteredData = [], logs = JSON.parse(localStorage.getItem('logs')) || [];
        let timer = 30, qrObj = null, lastReq = 0, isPaused = false;
        let classChart=null, timeChart=null, lineChart=null;
        let currentReq = null; // L∆∞u request ƒëang x·ª≠ l√Ω

        window.onload = () => {
            document.getElementById('viewDate').valueAsDate = new Date();
            applyUI(); startQR(); renderLogs();
            if(cfg.api) {
                // T·∫£i form config
                fetch(`${cfg.api}?action=GET_FORM_CONFIG`).then(r=>r.json()).then(res=>{
                    if(res.status==="success" && res.config) formCfg = res.config;
                    renderFormBuilder();
                }).catch(()=>renderFormBuilder());
                
                // Polling
                if(cfg.notifEnabled) setInterval(pollData, 5000);
            } else renderFormBuilder();
        };

        // --- H·ªÜ TH·ªêNG QR ---
        function startQR() {
            setInterval(() => {
                if(!isPaused) { timer--; document.getElementById('countdown').innerText = timer; if(timer<=0) { timer=cfg.time; updateQR(); } } else document.getElementById('countdown').innerText = "--";
            }, 1000);
            updateQR();
            setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleString('vi-VN'), 1000);
        }
        function updateQR() {
            const div=document.getElementById('qrcode');
            const url=`${cfg.link || window.location.href.replace('index.html','form.html')}?t=${Date.now()}`;
            if(!qrObj) { div.innerHTML=""; qrObj=new QRCode(div, {text:url, width:250, height:250, colorDark:cfg.qrColor}); }
            else { qrObj.clear(); qrObj.makeCode(url); }
            // Update Zoom
            const zDiv = document.getElementById('qrcodeZoom');
            if(zDiv.style.display !== 'none') { zDiv.innerHTML=""; new QRCode(zDiv, {text:url, width:300, height:300, colorDark:cfg.qrColor}); }
        }
        function applyUI() {
            document.getElementById('orgName').innerText = cfg.title;
            const mq = document.getElementById('marqueeContainer');
            mq.style.display = cfg.mqText ? 'block' : 'none';
            mq.innerHTML = `<marquee>${cfg.mqText}</marquee>`;
            if(cfg.darkMode) document.body.classList.add("dark-mode");
            updateTool('toolLive', cfg.notifEnabled);
            updateTool('toolDark', cfg.darkMode);
        }

        // --- POLLING DATA & NOTIFICATION ---
        function pollData() {
            const d = new Date().toISOString().split('T')[0];
            fetch(`${cfg.api}?action=GET_LIST&date=${d}`).then(r=>r.json()).then(r=>{
                if(r.status==="success") {
                    // Check Request M·ªõi
                    if(r.totalRequests > lastReq) {
                        fetch(`${cfg.api}?action=GET_LOGS`).then(l=>l.json()).then(logRes=>{
                             if(logRes.status==="success" && logRes.data.length > 0) {
                                 const req = logRes.data[0]; // L·∫•y c√°i m·ªõi nh·∫•t
                                 showToast(`üîî Y√™u c·∫ßu m·ªõi t·ª´ ${req.name}`, "warning");
                                 addLog("Y√™u c·∫ßu", `${req.name} (${req.mssv}): ${req.reason}`, "warning");
                             }
                        });
                        lastReq = r.totalRequests;
                        if(document.body.classList.contains('admin-open')) fetchList();
                    }
                    // Sync List Live
                    if(document.body.classList.contains('admin-open')) {
                        const oldLen = allData.length; allData = r.data;
                        if(allData.length > oldLen) {
                            showToast(`üë®‚Äçüéì ${allData.length - oldLen} sinh vi√™n m·ªõi ƒëi·ªÉm danh`);
                            applyFilter();
                        }
                    }
                }
            });
        }

        // --- X·ª¨ L√ù Y√äU C·∫¶U RESET (POPUP) ---
        function openReqModal(id, name, mssv, class_name, reason) {
            currentReq = { id, mssv, name };
            const info = `
                <p><strong>Sinh vi√™n:</strong> ${name}</p>
                <p><strong>MSSV:</strong> ${mssv}</p>
                <p><strong>L·ªõp:</strong> ${class_name}</p>
                <p><strong>L√Ω do:</strong> <span style="color:var(--danger)">${reason}</span></p>
            `;
            document.getElementById('reqInfo').innerHTML = info;
            document.getElementById('reqModal').style.display = 'flex';
        }
        function closeReqModal() { document.getElementById('reqModal').style.display = 'none'; currentReq = null; }
        function rejectReq() {
            alert("ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu.");
            closeReqModal();
            // C√≥ th·ªÉ th√™m logic g·ª≠i mail th√¥ng b√°o n·∫øu c·∫ßn
        }
        function approveReq() {
            if(!currentReq) return;
            // X√≥a d√≤ng d·ªØ li·ªáu c≈© ƒë·ªÉ cho ph√©p ƒëi·ªÉm danh l·∫°i
            // C·∫ßn t√¨m row_index c·ªßa sinh vi√™n n√†y trong allData
            const row = allData.find(x => x.unique_id == currentReq.id || x.mssv == currentReq.mssv);
            if(row) {
                deleteRow(row.row_index, true); // True = silent mode (ko confirm l·∫°i)
                showToast(`ƒê√£ ch·∫•p thu·∫≠n reset cho ${currentReq.name}`, "success");
            } else {
                alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒëi·ªÉm danh c≈© c·ªßa sinh vi√™n n√†y!");
            }
            closeReqModal();
        }

        // --- DATA TABLE ---
        function fetchList() {
            const d = document.getElementById('viewDate').value;
            document.getElementById('loader').style.display = 'block';
            fetch(`${cfg.api}?action=GET_LIST&date=${d}`).then(r=>r.json()).then(r=>{
                document.getElementById('loader').style.display = 'none';
                if(r.status==="success"){ allData = r.data; applyFilter(); }
            });
        }
        function applyFilter() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(i => JSON.stringify(i).toLowerCase().includes(term));
            
            // Render Header
            let hHTML = `<th style="width:40px"><input type="checkbox" onclick="toggleAll(this)"></th><th style="width:40px;text-align:center">üîî</th><th>Gi·ªù</th>`;
            formCfg.fields.forEach(f => hHTML += `<th>${f.label}</th>`);
            hHTML += `<th>X√≥a</th>`;
            document.getElementById('dynamicHeader').innerHTML = hHTML;

            // Render Body
            let html = "";
            filteredData.forEach(i => {
                // Bell Logic
                let bell = `<i class="fa-regular fa-bell" style="color:#cbd5e1"></i>`;
                if(i.request) {
                    bell = `<i class="fa-solid fa-bell bell-active" title="${i.request.reason}" onclick="openReqModal('${i.unique_id}', '${i.name}', '${i.mssv}', '${i.class_name}', '${i.request.reason}')"></i>`;
                }

                let cols = "";
                // Mapping Data
                formCfg.fields.forEach((f, idx) => {
                    let val = (i.data && i.data[idx]) ? i.data[idx] : "";
                    // Fallback for legacy data mapping
                    if(!val) {
                        if(idx===0) val = i.name;
                        if(idx===1) val = i.mssv;
                        if(idx===2) val = i.class_name;
                    }
                    cols += `<td>${val}</td>`;
                });

                html += `<tr>
                    <td><input type="checkbox" class="chk" value="${i.row_index}"></td>
                    <td class="bell-cell">${bell}</td>
                    <td>${i.time.split(' ')[0]}</td>
                    ${cols}
                    <td><i class="fa-solid fa-trash" style="color:var(--danger); cursor:pointer" onclick="deleteRow(${i.row_index})"></i></td>
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = html || '<tr><td colspan="10" style="text-align:center">Tr·ªëng</td></tr>';
            
            // Update Stats
            document.getElementById('statTotal').innerText = filteredData.length;
            document.getElementById('statReq').innerText = filteredData.filter(i=>i.request).length;
            if(filteredData.length) document.getElementById('statLatest').innerText = filteredData[0].time.split(' ')[0];
            
            renderCharts();
        }

        // --- CHARTS (ƒê·∫∏P H∆†N) ---
        function renderCharts() {
            const ctx1=document.getElementById('classChart'); const ctx2=document.getElementById('timeChart'); const ctx3=document.getElementById('lineChart');
            
            // Data Process
            const classes={}, times={}, timeline={};
            filteredData.forEach(i => {
                let cls = (i.data && i.data[2]) ? i.data[2] : "Kh√°c"; // Gi·∫£ ƒë·ªãnh c·ªôt 3 l√† l·ªõp
                classes[cls] = (classes[cls]||0)+1;
                let h = i.time.split(":")[0] + "h";
                times[h] = (times[h]||0)+1;
                // Timeline dummy logic (gom theo gi·ªù ƒë·ªÉ demo)
                timeline[h] = (timeline[h]||0)+1;
            });

            // Colors
            const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            if(classChart) classChart.destroy();
            classChart = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: Object.keys(classes), datasets: [{ data: Object.values(classes), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            if(timeChart) timeChart.destroy();
            timeChart = new Chart(ctx2, {
                type: 'bar',
                data: { labels: Object.keys(times).sort(), datasets: [{ label: 'S·ªë l∆∞·ª£ng', data: Object.values(times), backgroundColor: '#4f46e5', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx3, {
                type: 'line',
                data: { labels: Object.keys(timeline).sort(), datasets: [{ label: 'Xu h∆∞·ªõng', data: Object.values(timeline), borderColor: '#10b981', tension: 0.4, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- ACTIONS ---
        function deleteRow(idx, silent=false) {
            if(!silent && !confirm("X√≥a d√≤ng n√†y?")) return;
            fetch(cfg.api, {method:'POST', body:JSON.stringify({action:"DELETE_ROW", row_index:idx})}).then(r=>r.json()).then(r=>{
                if(r.status==="success") { 
                    if(!silent) alert("ƒê√£ x√≥a!"); 
                    fetchList(); 
                    addLog("D·ªØ li·ªáu", "ƒê√£ x√≥a 1 b·∫£n ghi", "danger");
                }
            });
        }
        function deleteSelected() {
            const chks = document.querySelectorAll('.chk:checked');
            if(!chks.length || !confirm(`X√≥a ${chks.length} m·ª•c?`)) return;
            const indices = Array.from(chks).map(c=>parseInt(c.value));
            fetch(cfg.api, {method:'POST', body:JSON.stringify({action:"DELETE_BULK", indices: indices})}).then(()=>{
                alert("ƒê√£ x√≥a xong!"); fetchList();
            });
        }
        function toggleAll(src) { document.querySelectorAll('.chk').forEach(c => c.checked = src.checked); checkBulk(); }
        function checkBulk() { const n = document.querySelectorAll('.chk:checked').length; document.getElementById('btnBulkDelete').style.display = n > 0 ? 'inline-block' : 'none'; }

        // --- FORM CONFIG ---
        function renderFormBuilder() {
            const c = document.getElementById('fbFields'); c.innerHTML = "";
            formCfg.fields.forEach((f, i) => {
                c.innerHTML += `
                <div class="fb-item">
                    <div class="fb-settings">
                        <input type="text" value="${f.label}" onchange="formCfg.fields[${i}].label=this.value" placeholder="T√™n tr∆∞·ªùng">
                        <select onchange="formCfg.fields[${i}].type=this.value"><option value="text" ${f.type=='text'?'selected':''}>Ch·ªØ</option><option value="tel" ${f.type=='tel'?'selected':''}>S·ªë</option></select>
                        <select onchange="formCfg.fields[${i}].format=this.value"><option value="none" ${f.format=='none'?'selected':''}>None</option><option value="uppercase" ${f.format=='uppercase'?'selected':''}>IN HOA</option><option value="capitalize" ${f.format=='capitalize'?'selected':''}>Vi·∫øt Hoa</option></select>
                        <label><input type="checkbox" ${f.required?'checked':''} onchange="formCfg.fields[${i}].required=this.checked"> B·∫Øt bu·ªôc</label>
                        <i class="fa-solid fa-trash" style="color:red; cursor:pointer" onclick="removeField(${i})"></i>
                    </div>
                </div>`;
            });
            document.getElementById('fbTitle').value = formCfg.title;
        }
        function addFormField() { formCfg.fields.push({label:"M·ªõi", type:"text", format:"none", required:false}); renderFormBuilder(); }
        function removeField(i) { if(confirm("X√≥a?")) { formCfg.fields.splice(i, 1); renderFormBuilder(); } }
        function saveFormConfig() {
            formCfg.title = document.getElementById('fbTitle').value;
            fetch(cfg.api, {method:'POST', body:JSON.stringify({action:"SAVE_FORM_CONFIG", config:formCfg})}).then(()=>{
                alert("ƒê√£ l∆∞u Form!"); addLog("Form", "C·∫≠p nh·∫≠t c·∫•u h√¨nh", "success");
            });
        }

        // --- SYSTEM & AUTH ---
        function openAuth() { document.getElementById('authModal').style.display='flex'; document.getElementById('loginPass').value=""; document.getElementById('loginPass').focus(); }
        function closeAuthModal() { document.getElementById('authModal').style.display='none'; }
        function doLogin() {
            if(document.getElementById('loginPass').value === cfg.pass) {
                closeAuthModal();
                document.body.classList.add('admin-open');
                // Fill Config
                document.getElementById('cfgApi').value = cfg.api;
                document.getElementById('cfgPass').value = cfg.pass;
                document.getElementById('cfgReset').value = cfg.reset;
                document.getElementById('cfgTitle').value = cfg.title;
                document.getElementById('cfgMqText').value = cfg.mqText;
                document.getElementById('cfgQrColor').value = cfg.qrColor;
                fetchList();
                addLog("H·ªá th·ªëng", "Admin ƒëƒÉng nh·∫≠p", "success");
            } else alert("Sai m·∫≠t kh·∫©u");
        }
        function closeAdmin() { document.body.classList.remove('admin-open'); }
        function unlockField(id) { if(prompt("Nh·∫≠p m√£ c·∫•p 2:")==="1234") { document.getElementById(id).readOnly=false; document.getElementById(id).classList.add('unlocked'); } }
        function saveSystemConfig() {
            cfg.api = document.getElementById('cfgApi').value;
            cfg.pass = document.getElementById('cfgPass').value;
            cfg.reset = document.getElementById('cfgReset').value;
            cfg.title = document.getElementById('cfgTitle').value;
            cfg.mqText = document.getElementById('cfgMqText').value;
            cfg.qrColor = document.getElementById('cfgQrColor').value;
            localStorage.setItem('qr_cfg', JSON.stringify(cfg));
            localStorage.setItem('admin_reset_pass', cfg.reset); // ƒê·ªìng b·ªô pass reset
            alert("ƒê√£ l∆∞u!"); location.reload();
        }

        // --- TOOLS & UTILS ---
        function showToast(msg, type="success") {
            const d = document.createElement('div'); d.className = `live-toast ${type}`;
            d.innerHTML = `<i class="fa-solid fa-info-circle" style="color:${type==='warning'?'orange':'#10b981'}"></i> <span>${msg}</span>`;
            document.getElementById('liveToastContainer').prepend(d); setTimeout(()=>d.remove(), 5000);
        }
        function addLog(title, msg, type) {
            logs.unshift({title, msg, type, t: new Date().toLocaleTimeString()});
            if(logs.length > 50) logs.pop();
            localStorage.setItem('logs', JSON.stringify(logs));
            renderLogs();
        }
        function renderLogs() {
            document.getElementById('logList').innerHTML = logs.map(l=>`
                <li class="timeline-item ${l.type}">
                    <div class="log-card"><div class="log-header"><span>${l.title}</span><span>${l.t}</span></div><div>${l.msg}</div></div>
                </li>`).join('');
        }
        function clearLocalLogs() { logs=[]; localStorage.setItem('logs','[]'); renderLogs(); }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.style.display='none'); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).style.display='block'; event.currentTarget.classList.add('active'); }
        function toggleFullAdmin() { document.body.classList.toggle('full-width'); }
        
        function updateTool(id, active) { 
            const el = document.getElementById(id); 
            if(active) el.classList.add('tool-active'); else el.classList.remove('tool-active'); 
        }
        
        // Tool Actions
        function toggleLiveNotif() { cfg.notifEnabled=!cfg.notifEnabled; localStorage.setItem('qr_cfg',JSON.stringify(cfg)); updateTool('toolLive', cfg.notifEnabled); }
        function togglePause() { isPaused=!isPaused; updateTool('toolPause', isPaused); showToast(isPaused?"ƒê√£ T·∫°m D·ª´ng":"ƒê√£ Ti·∫øp T·ª•c"); }
        function toggleDarkMode() { cfg.darkMode=!cfg.darkMode; localStorage.setItem('qr_cfg',JSON.stringify(cfg)); applyUI(); }
        function downloadQR() { const i=document.querySelector('#qrcode img'); if(i){ const a=document.createElement('a'); a.href=i.src; a.download='QR.png'; a.click(); } }
        function exportCSV() { if(allData.length){ let c="Time,Data\n"; allData.forEach(r=>c+=`${r.time},${r.data.join(',')}\n`); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c])); a.download='Data.csv'; a.click(); } else alert("Tr·ªëng"); }
        function zoomQR() { document.getElementById('qrZoomModal').style.display='flex'; new QRCode(document.getElementById('qrcodeZoom'), {text:cfg.link, width:300, height:300}); }
        function openFormLink() { window.open(cfg.link, '_blank'); }
    </script>
</body>
</html>
