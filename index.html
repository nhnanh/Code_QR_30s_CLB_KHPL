<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QU·∫¢N TR·ªä ƒêI·ªÇM DANH PRO MAX</title>
    
    <!-- Th∆∞ vi·ªán QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Th∆∞ vi·ªán Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Th∆∞ vi·ªán Bi·ªÉu ƒë·ªì (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --text: #1e293b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body.dark-mode {
            --primary: #60a5fa;
            --bg: #0f172a;
            --text: #f1f5f9;
            --white: #1e293b;
            --border: #334155;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; transition: 0.3s; }
        
        /* --- GIAO DI·ªÜN QR --- */
        .settings-btn { position: absolute; top: 20px; left: 20px; font-size: 28px; color: #94a3b8; cursor: pointer; padding: 10px; z-index: 100; transition: 0.3s; }
        .settings-btn:hover { color: var(--primary); transform: rotate(90deg); }

        .qr-card { background: var(--white); padding: 40px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; width: 380px; position: relative; z-index: 10; border: 1px solid var(--border); transition: 0.3s; }
        #qrcode { background: var(--white); padding: 15px; border: 2px dashed #cbd5e1; border-radius: 16px; display: inline-block; margin: 20px 0; transition: 0.3s; }
        .timer { font-size: 64px; font-weight: 900; color: var(--danger); line-height: 1; font-variant-numeric: tabular-nums; }
        .realtime { margin-top: 20px; font-weight: 600; color: #64748b; border-top: 1px solid var(--border); padding-top: 15px;}

        /* Hi·ªáu ·ª©ng m·ªù QR */
        .blur-effect { filter: blur(15px); opacity: 0.5; pointer-events: none; }

        /* Marquee */
        .marquee-container {
            position: fixed; left: 0; width: 100%;
            padding: 10px 0; font-weight: bold; font-size: 16px;
            z-index: 50; text-transform: uppercase;
            display: none;
        }
        .marquee-top { top: 0; }
        .marquee-bottom { bottom: 0; }

        /* --- MODAL ADMIN --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--white); width: 95%; max-width: 1000px; border-radius: 16px; display: flex; flex-direction: column; max-height: 95vh; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; }
        
        .modal-header { padding: 15px 25px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .close-modal { font-size: 24px; cursor: pointer; color: #94a3b8; }
        .close-modal:hover { color: var(--danger); }

        .modal-body { padding: 20px; overflow-y: auto; background: var(--bg); flex: 1; display: flex; flex-direction: column; }

        /* --- TABS --- */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: var(--white); padding: 5px; border-radius: 10px; border: 1px solid var(--border); width: fit-content; }
        .tab-btn { padding: 8px 16px; border: none; background: none; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; transition: 0.2s; font-size: 13px; }
        .tab-btn:hover { background: #f1f5f9; }
        .tab-btn.active { background: var(--primary); color: white; shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tab-content { display: none; animation: fadeEffect 0.3s; flex: 1; }
        .tab-content.active { display: flex; flex-direction: column; }
        @keyframes fadeEffect { from {opacity: 0; transform: translateY(5px);} to {opacity: 1; transform: translateY(0);} }

        /* --- DASHBOARD & CHARTS --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-info h4 { margin: 0; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-info p { margin: 5px 0 0 0; font-size: 24px; font-weight: 800; color: var(--text); }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; min-height: 300px; }
        .chart-box { background: var(--white); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .chart-title { font-weight: 700; margin-bottom: 15px; font-size: 14px; color: #475569; display: flex; justify-content: space-between; }
        .chart-canvas-container { flex: 1; position: relative; min-height: 250px; }

        /* --- DATA TABLE --- */
        .excel-toolbar { background: var(--white); padding: 10px; border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .excel-table-container { flex: 1; overflow: auto; border: 1px solid var(--border); background: var(--white); border-radius: 0 0 8px 8px; min-height: 300px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: var(--bg); padding: 12px; text-align: left; font-weight: 700; color: #475569; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; color: var(--primary); }
        th i { font-size: 10px; margin-left: 5px; opacity: 0.5; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text); }
        tr:hover td { background-color: #f0fdfa; }

        /* Custom Checkbox */
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }

        /* --- TOOLS GRID (TI·ªÜN √çCH) --- */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding-bottom: 20px;}
        .tool-card { background: var(--white); padding: 15px 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); height: 100px; }
        .tool-card:hover { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tool-card i { font-size: 24px; color: var(--primary); margin-bottom: 5px; }
        .tool-card span { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.2; }
        .tool-danger i { color: var(--danger); }
        .tool-warning i { color: var(--warning); }
        .tool-success i { color: var(--success); }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: var(--text); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; background: var(--white); color: var(--text); }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-gray { background: #64748b; }
        .btn-warning { background: var(--warning); color: #fff; }
        
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 50;}
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Lock Screen Overlay */
        #lockScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #qrZoomModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }

        @media (max-width: 768px) {
            .charts-row { grid-template-columns: 1fr; }
            .excel-toolbar { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div class="settings-btn" onclick="checkLogin()"><i class="fa-solid fa-sliders"></i></div>

    <!-- M√†n h√¨nh QR -->
    <div class="qr-card" id="mainCard">
        <h1 id="orgName" style="color:var(--primary)">ƒêI·ªÇM DANH CLB</h1>
        <div id="qrcode"></div>
        <div class="timer" id="countdown">--</div>
        <div style="font-size:13px; color:#94a3b8; margin-top:5px;">Gi√¢y l√†m m·ªõi</div>
        <div class="realtime"><i class="fa-regular fa-clock"></i> <span id="clock">Loading...</span></div>
    </div>

    <!-- M√†n h√¨nh Kh√≥a -->
    <div id="lockScreen">
        <i class="fa-solid fa-lock fa-4x" style="margin-bottom:20px"></i>
        <h2>H·ªÜ TH·ªêNG ƒêANG KH√ìA</h2>
        <p>Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ m·ªü l·∫°i</p>
        <button class="btn btn-primary" onclick="unlockScreen()" style="margin-top:20px; font-size:16px;">M·ªû KH√ìA</button>
    </div>

    <!-- M√†n h√¨nh Zoom QR -->
    <div id="qrZoomModal">
        <h2 style="color:var(--text)">QU√âT M√É ƒêI·ªÇM DANH</h2>
        <div id="qrcodeZoom" style="transform: scale(1.5); margin: 50px;"></div>
        <button class="btn btn-danger" onclick="closeZoom()">ƒê√≥ng (ESC)</button>
    </div>

    <!-- Ch·ªØ ch·∫°y -->
    <div id="marqueeContainer" class="marquee-container">
        <marquee id="marqueeText"></marquee>
    </div>

    <!-- MODAL ADMIN -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fa-solid fa-shield-halved"></i> QU·∫¢N TR·ªä VI√äN</div>
                <div class="close-modal" onclick="closeModal()">&times;</div>
            </div>

            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('tab-stats')"><i class="fa-solid fa-chart-pie"></i> Th·ªëng K√™</button>
                    <button class="tab-btn" onclick="switchTab('tab-data')"><i class="fa-solid fa-table"></i> D·ªØ Li·ªáu</button>
                    <button class="tab-btn" onclick="switchTab('tab-tools')"><i class="fa-solid fa-toolbox"></i> Ti·ªán √çch</button>
                    <button class="tab-btn" onclick="switchTab('tab-config')"><i class="fa-solid fa-gear"></i> C·∫•u H√¨nh</button>
                </div>

                <div id="loader" class="loader"></div>

                <!-- TAB 1: TH·ªêNG K√ä & BI·ªÇU ƒê·ªí -->
                <div id="tab-stats" class="tab-content active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#dbeafe; color:var(--primary)"><i class="fa-solid fa-users"></i></div>
                            <div class="stat-info"><h4>T·ªïng Sinh Vi√™n</h4><p id="statTotal">0</p></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#dcfce7; color:var(--success)"><i class="fa-solid fa-layer-group"></i></div>
                            <div class="stat-info"><h4>S·ªë L·ªõp</h4><p id="statClasses">0</p></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#fee2e2; color:var(--danger)"><i class="fa-regular fa-clock"></i></div>
                            <div class="stat-info"><h4>M·ªõi nh·∫•t</h4><p id="statLatest" style="font-size:18px">--:--</p></div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-box">
                            <div class="chart-title"><span><i class="fa-solid fa-chart-column"></i> M·∫≠t ƒë·ªô ƒëi·ªÉm danh (Gi·ªù)</span></div>
                            <div class="chart-canvas-container"><canvas id="timeChart"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <div class="chart-title"><span><i class="fa-solid fa-chart-pie"></i> T·ª∑ l·ªá tham gia theo L·ªõp</span></div>
                            <div class="chart-canvas-container"><canvas id="classChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: D·ªÆ LI·ªÜU EXCEL -->
                <div id="tab-data" class="tab-content">
                    <div class="excel-toolbar">
                        <div style="flex:1"><input type="date" id="viewDate" onchange="fetchList()"></div>
                        <div style="flex:2"><input type="text" id="searchInput" placeholder="üîç L·ªçc nhanh..." onkeyup="applyFilter()"></div>
                        <button class="btn btn-danger" id="btnBulkDelete" onclick="deleteSelected()" style="display:none;"><i class="fa-solid fa-trash"></i> X√≥a m·ª•c ƒë√£ ch·ªçn</button>
                        <button class="btn btn-primary" onclick="fetchList()"><i class="fa-solid fa-rotate"></i> T·∫£i l·∫°i</button>
                    </div>
                    <div class="excel-table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th style="width:40px; text-align:center"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                    <th onclick="sortTable('time')">Gi·ªù <i class="fa-solid fa-sort"></i></th>
                                    <th onclick="sortTable('name')">H·ªç v√† T√™n <i class="fa-solid fa-sort"></i></th>
                                    <th onclick="sortTable('mssv')">MSSV <i class="fa-solid fa-sort"></i></th>
                                    <th onclick="sortTable('class_name')">L·ªõp <i class="fa-solid fa-sort"></i></th>
                                    <th style="text-align:center">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"><tr><td colspan="6" style="text-align:center; padding:30px; color:#999">Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xem d·ªØ li·ªáu</td></tr></tbody>
                        </table>
                    </div>
                    <div style="margin-top:10px; font-size:12px; color:#64748b; text-align:right">T·ªïng d√≤ng hi·ªÉn th·ªã: <b id="rowCount">0</b></div>
                </div>

                <!-- TAB 3: TI·ªÜN √çCH -->
                <div id="tab-tools" class="tab-content">
                    <div class="tools-grid">
                        <div class="tool-card" onclick="togglePause()"><i class="fa-solid fa-pause"></i><span>T·∫°m d·ª´ng</span></div>
                        <div class="tool-card" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i><span>Ch·∫ø ƒë·ªô T·ªëi</span></div>
                        <div class="tool-card" onclick="toggleFullscreen()"><i class="fa-solid fa-expand"></i><span>To√†n m√†n h√¨nh</span></div>
                        <div class="tool-card" onclick="downloadQR()"><i class="fa-solid fa-download"></i><span>T·∫£i ·∫£nh QR</span></div>
                        
                        <div class="tool-card" onclick="zoomQR()"><i class="fa-solid fa-magnifying-glass-plus"></i><span>Ph√≥ng to QR</span></div>
                        <div class="tool-card" onclick="toggleBlurQR()"><i class="fa-solid fa-eye-slash"></i><span>Che m·ªù QR</span></div>
                        <div class="tool-card" onclick="toggleClockUI()"><i class="fa-regular fa-clock"></i><span>·∫®n/Hi·ªán Gi·ªù</span></div>
                        <div class="tool-card tool-warning" onclick="lockScreen()"><i class="fa-solid fa-lock"></i><span>Kh√≥a m√†n h√¨nh</span></div>
                        
                        <div class="tool-card" onclick="randomStudent()"><i class="fa-solid fa-shuffle"></i><span>Quay s·ªë ng·∫´u nhi√™n</span></div>
                        <div class="tool-card tool-success" onclick="exportCSV()"><i class="fa-solid fa-file-csv"></i><span>Xu·∫•t Excel (CSV)</span></div>
                        <div class="tool-card" onclick="printList()"><i class="fa-solid fa-print"></i><span>In Danh s√°ch</span></div>
                        <div class="tool-card" onclick="exportConfig()"><i class="fa-solid fa-file-export"></i><span>Sao l∆∞u C√†i ƒë·∫∑t</span></div>
                        
                        <div class="tool-card" onclick="importConfig()"><i class="fa-solid fa-file-import"></i><span>Kh√¥i ph·ª•c C√†i ƒë·∫∑t</span></div>
                        <div class="tool-card" onclick="openFormLink()"><i class="fa-solid fa-external-link-alt"></i><span>M·ªü Link Form</span></div>
                        <div class="tool-card" onclick="showStaticQR()"><i class="fa-solid fa-qrcode"></i><span>QR Tƒ©nh (In)</span></div>
                        <div class="tool-card" onclick="checkPing()"><i class="fa-solid fa-wifi"></i><span>Ki·ªÉm tra M·∫°ng</span></div>
                        
                        <div class="tool-card" onclick="toggleNote()"><i class="fa-solid fa-sticky-note"></i><span>Ghi ch√∫ Nhanh</span></div>
                        <div class="tool-card tool-warning" onclick="startTimer5()"><i class="fa-solid fa-hourglass-start"></i><span>ƒê·∫øm ng∆∞·ª£c 5p</span></div>
                        <div class="tool-card" onclick="fetchList()"><i class="fa-solid fa-sync"></i><span>L√†m m·ªõi DL</span></div>
                    </div>
                    
                    <!-- Khu v·ª±c Note Pad (·∫®n m·∫∑c ƒë·ªãnh) -->
                    <div id="notePad" style="display:none; margin-top:15px;">
                        <textarea id="adminNote" style="width:100%; height:80px; padding:10px; border-radius:8px; border:1px solid #cbd5e1" placeholder="Ghi ch√∫ t·∫°m th·ªùi..."></textarea>
                        <button class="btn btn-primary" onclick="saveNote()">L∆∞u Ghi Ch√∫</button>
                    </div>
                </div>

                <!-- TAB 4: C·∫§U H√åNH -->
                <div id="tab-config" class="tab-content">
                    <!-- Config chung -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                        <div class="form-group"><label>Ti√™u ƒë·ªÅ trang:</label><input type="text" id="cfgTitle"></div>
                        <div class="form-group"><label>Link Form (form.html):</label><input type="text" id="cfgLink"></div>
                    </div>
                    
                    <div class="form-group"><label>API Google Apps Script:</label><input type="text" id="cfgApi"></div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
                        <div class="form-group"><label>Th·ªùi gian QR (s):</label><input type="number" id="cfgTime" value="30"></div>
                        <div class="form-group"><label>Pass Admin:</label><input type="text" id="cfgPass"></div>
                        <div class="form-group"><label>Pass Reset M√°y:</label><input type="text" id="cfgResetPass"></div>
                    </div>

                    <!-- Config Ch·ªØ ch·∫°y -->
                    <fieldset style="border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-top:10px">
                        <legend style="font-size:12px; font-weight:bold; color:var(--primary)">C√†i ƒë·∫∑t Ch·ªØ ch·∫°y (Marquee)</legend>
                        <div class="form-group"><label>N·ªôi dung:</label><input type="text" id="cfgMqText"></div>
                        <div style="display:flex; gap:10px">
                            <div style="flex:1"><label>V·ªã tr√≠:</label>
                                <select id="cfgMqPos"><option value="none">T·∫Øt</option><option value="bottom">D∆∞·ªõi ƒë√°y</option><option value="top">Tr√™n c√πng</option></select>
                            </div>
                            <div style="flex:1"><label>M√†u n·ªÅn:</label><input type="color" id="cfgMqBg" style="height:40px; padding:2px"></div>
                            <div style="flex:1"><label>M√†u ch·ªØ:</label><input type="color" id="cfgMqColor" style="height:40px; padding:2px"></div>
                        </div>
                    </fieldset>

                    <!-- Config QR -->
                    <fieldset style="border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-top:10px">
                        <legend style="font-size:12px; font-weight:bold; color:var(--primary)">T√πy ch·ªânh QR Code</legend>
                        <div style="display:flex; gap:10px">
                            <div style="flex:1"><label>M√†u m√£:</label><input type="color" id="cfgQrColor" value="#000000" style="height:40px; padding:2px"></div>
                            <div style="flex:1"><label>M√†u n·ªÅn:</label><input type="color" id="cfgQrBg" value="#ffffff" style="height:40px; padding:2px"></div>
                            <div style="flex:1"><label>ƒê·ªô chi ti·∫øt:</label>
                                <select id="cfgQrLevel">
                                    <option value="L">Th·∫•p (L)</option>
                                    <option value="M">Trung b√¨nh (M)</option>
                                    <option value="Q">Cao (Q)</option>
                                    <option value="H">T·ªët nh·∫•t (H)</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button class="btn btn-gray" onclick="closeModal()">H·ªßy</button>
                        <button class="btn btn-primary" onclick="saveConfig()"><i class="fa-solid fa-floppy-disk"></i> L∆∞u C·∫•u H√¨nh</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH M·∫∂C ƒê·ªäNH ---
        const DEFAULT_CONFIG = {
            link: "https://nhnanh.github.io/Code_QR_30s_CLB_KHPL/form.html",
            api: "",
            time: 30,
            pass: "Admin",
            resetPass: "Admin",
            title: "ƒêI·ªÇM DANH CLB",
            mqText: "H·ªÜ TH·ªêNG ƒêANG M·ªû ƒêI·ªÇM DANH",
            mqPos: "bottom",
            mqBg: "#ef4444",
            mqColor: "#ffffff",
            qrColor: "#000000",
            qrBg: "#ffffff",
            qrLevel: "M",
            darkMode: false
        };

        // Bi·∫øn to√†n c·ª•c
        let config = JSON.parse(localStorage.getItem('qr_config_max')) || DEFAULT_CONFIG;
        let allData = [], filteredData = [], sortState = { key: 'time', dir: 'desc' };
        let timer = config.time, qrObj = null, interval = null, isPaused = false;
        let classChartInstance = null, timeChartInstance = null;

        // --- KH·ªûI T·∫†O ---
        window.onload = function() {
            document.getElementById('viewDate').valueAsDate = new Date();
            document.getElementById('adminNote').value = localStorage.getItem('admin_note') || "";
            applyUI();
            startSystem();
            setInterval(() => document.getElementById("clock").innerText = new Date().toLocaleString("vi-VN"), 1000);
        };

        // --- H·ªÜ TH·ªêNG QR ---
        function startSystem() {
            if (interval) clearInterval(interval);
            updateQR();
            timer = config.time;
            interval = setInterval(() => {
                if(!isPaused) {
                    timer--;
                    document.getElementById("countdown").innerText = timer;
                    if (timer <= 0) { timer = config.time; updateQR(); }
                } else {
                    document.getElementById("countdown").innerText = "--";
                }
            }, 1000);
        }

        function updateQR() {
            const qrDiv = document.getElementById("qrcode");
            const token = Date.now(); 
            const finalLink = `${config.link}?t=${token}`;
            if (qrObj === null) {
                qrDiv.innerHTML = "";
                qrObj = new QRCode(qrDiv, { 
                    text: finalLink, 
                    width: 250, height: 250, 
                    colorDark : config.qrColor, 
                    colorLight: config.qrBg,
                    correctLevel: QRCode.CorrectLevel[config.qrLevel] 
                });
            } else {
                qrObj.clear();
                qrObj.makeCode(finalLink);
            }
            
            // Update Zoom QR
            const zoomDiv = document.getElementById("qrcodeZoom");
            if(zoomDiv.style.display !== 'none') {
                zoomDiv.innerHTML = "";
                new QRCode(zoomDiv, { 
                    text: finalLink, width: 250, height: 250, 
                    colorDark : config.qrColor, colorLight: config.qrBg, 
                    correctLevel: QRCode.CorrectLevel[config.qrLevel]
                });
            }
        }

        function applyUI() {
            document.getElementById("orgName").innerText = config.title;
            if(config.darkMode) document.body.classList.add("dark-mode");
            else document.body.classList.remove("dark-mode");

            const mq = document.getElementById("marqueeContainer");
            if(config.mqPos === "none") { mq.style.display = "none"; }
            else {
                mq.style.display = "block";
                mq.className = "marquee-container " + (config.mqPos === "top" ? "marquee-top" : "marquee-bottom");
                mq.style.background = config.mqBg;
                mq.style.color = config.mqColor;
                mq.innerHTML = `<marquee>${config.mqText}</marquee>`;
            }
        }

        // --- ADMIN MODAL ---
        function checkLogin() {
            const p = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
            if(p === config.pass) {
                document.getElementById("adminModal").style.display = "flex";
                // Fill config
                document.getElementById("cfgTitle").value = config.title;
                document.getElementById("cfgLink").value = config.link;
                document.getElementById("cfgApi").value = config.api;
                document.getElementById("cfgTime").value = config.time;
                document.getElementById("cfgPass").value = config.pass;
                document.getElementById("cfgResetPass").value = config.resetPass;
                document.getElementById("cfgMqText").value = config.mqText;
                document.getElementById("cfgMqPos").value = config.mqPos;
                document.getElementById("cfgMqBg").value = config.mqBg;
                document.getElementById("cfgMqColor").value = config.mqColor;
                document.getElementById("cfgQrColor").value = config.qrColor || "#000000";
                document.getElementById("cfgQrBg").value = config.qrBg || "#ffffff";
                document.getElementById("cfgQrLevel").value = config.qrLevel || "M";
                fetchList(); // Load data
            } else if(p !== null) alert("Sai m·∫≠t kh·∫©u!");
        }

        function saveConfig() {
            config.title = document.getElementById("cfgTitle").value;
            config.link = document.getElementById("cfgLink").value;
            config.api = document.getElementById("cfgApi").value;
            config.time = parseInt(document.getElementById("cfgTime").value);
            config.pass = document.getElementById("cfgPass").value;
            config.resetPass = document.getElementById("cfgResetPass").value;
            config.mqText = document.getElementById("cfgMqText").value;
            config.mqPos = document.getElementById("cfgMqPos").value;
            config.mqBg = document.getElementById("cfgMqBg").value;
            config.mqColor = document.getElementById("cfgMqColor").value;
            config.qrColor = document.getElementById("cfgQrColor").value;
            config.qrBg = document.getElementById("cfgQrBg").value;
            config.qrLevel = document.getElementById("cfgQrLevel").value;

            localStorage.setItem('qr_config_max', JSON.stringify(config));
            localStorage.setItem('admin_reset_pass', config.resetPass); 
            
            alert("ƒê√£ l∆∞u c·∫•u h√¨nh!");
            closeModal();
            qrObj = null; document.getElementById("qrcode").innerHTML = ""; // Reset QR ƒë·ªÉ v·∫Ω m√†u m·ªõi
            applyUI();
            startSystem();
        }

        function closeModal() { document.getElementById("adminModal").style.display = "none"; }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- FETCH & CHART ---
        function fetchList() {
            if(!config.api) { return; }
            const date = document.getElementById('viewDate').value;
            document.getElementById('loader').style.display = "block";

            fetch(`${config.api}?action=GET_LIST&date=${date}`)
            .then(res => res.json())
            .then(res => {
                document.getElementById('loader').style.display = "none";
                if(res.status === "success") {
                    allData = res.data;
                    applyFilter();
                }
            })
            .catch(() => { document.getElementById('loader').style.display = "none"; });
        }

        function applyFilter() {
            const term = document.getElementById("searchInput").value.toLowerCase();
            filteredData = allData.filter(i => i.name.toLowerCase().includes(term) || i.mssv.toString().includes(term) || i.class_name.toLowerCase().includes(term));
            
            // Sort
            const k = sortState.key, d = sortState.dir;
            filteredData.sort((a,b) => {
                let va = a[k].toLowerCase(), vb = b[k].toLowerCase();
                return (va < vb ? -1 : 1) * (d === 'asc' ? 1 : -1);
            });

            renderTable();
            renderStats();
        }

        function sortTable(key) {
            sortState.key = key;
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            applyFilter();
        }

        // --- RENDER TABLE V·ªöI CHECKBOX ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            document.getElementById('rowCount').innerText = filteredData.length;
            
            // ·∫®n/Hi·ªán n√∫t x√≥a nhi·ªÅu
            const btnBulk = document.getElementById('btnBulkDelete');
            
            if(filteredData.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; btnBulk.style.display="none"; return; }
            
            let html = "";
            filteredData.forEach(item => {
                html += `<tr>
                    <td style="text-align:center"><input type="checkbox" class="row-checkbox" value="${item.row_index}|${item.mssv}" onclick="updateBulkButton()"></td>
                    <td>${item.time.split(" ")[0]}</td><td><b>${item.name}</b></td><td>${item.mssv}</td><td>${item.class_name}</td>
                    <td style="text-align:center"><i class="fa-solid fa-trash" style="color:var(--danger); cursor:pointer" onclick="deleteRow(${item.row_index},'${item.mssv}')"></i></td>
                </tr>`;
            });
            tbody.innerHTML = html;
            updateBulkButton();
        }

        function toggleSelectAll() {
            const master = document.getElementById('selectAll');
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = master.checked);
            updateBulkButton();
        }

        function updateBulkButton() {
            const count = document.querySelectorAll('.row-checkbox:checked').length;
            const btn = document.getElementById('btnBulkDelete');
            if (count > 0) {
                btn.style.display = 'inline-flex';
                btn.innerHTML = `<i class="fa-solid fa-trash"></i> X√≥a (${count}) m·ª•c`;
            } else {
                btn.style.display = 'none';
            }
        }

        // --- X√ìA NHI·ªÄU SINH VI√äN ---
        async function deleteSelected() {
            const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            if(selected.length === 0) return;
            if(!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selected.length} sinh vi√™n ƒë√£ ch·ªçn?`)) return;

            // L·∫•y danh s√°ch c·∫ßn x√≥a v√† s·∫Øp x·∫øp index gi·∫£m d·∫ßn (ƒë·ªÉ x√≥a t·ª´ d∆∞·ªõi l√™n kh√¥ng b·ªã l·ªách d√≤ng)
            let itemsToDelete = selected.map(cb => {
                let parts = cb.value.split('|');
                return { index: parseInt(parts[0]), mssv: parts[1] };
            }).sort((a, b) => b.index - a.index);

            // Hi·ªÉn th·ªã loading
            document.getElementById('loader').style.display = 'block';
            let successCount = 0;

            // X√≥a tu·∫ßn t·ª±
            for (const item of itemsToDelete) {
                try {
                    await fetch(config.api, {
                        method: 'POST',
                        body: JSON.stringify({ action: "DELETE_ROW", row_index: item.index, mssv: item.mssv })
                    });
                    successCount++;
                } catch(e) { console.error(e); }
            }

            document.getElementById('loader').style.display = 'none';
            alert(`ƒê√£ x√≥a xong ${successCount} sinh vi√™n!`);
            fetchList(); // T·∫£i l·∫°i b·∫£ng
        }

        function renderStats() {
            document.getElementById('statTotal').innerText = filteredData.length;
            
            // Prepare Data Chart
            const classCount = {}, timeCount = {};
            filteredData.forEach(i => {
                classCount[i.class_name] = (classCount[i.class_name] || 0) + 1;
                let h = i.time.split(":")[0] + "h";
                timeCount[h] = (timeCount[h] || 0) + 1;
            });
            document.getElementById('statClasses').innerText = Object.keys(classCount).length;
            if(filteredData.length > 0) document.getElementById('statLatest').innerText = filteredData[0].time.split(" ")[0];

            // Render Charts
            const ctx1 = document.getElementById('classChart').getContext('2d');
            if(classChartInstance) classChartInstance.destroy();
            classChartInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(classCount), datasets: [{ data: Object.values(classCount), backgroundColor: ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] }});

            const ctx2 = document.getElementById('timeChart').getContext('2d');
            if(timeChartInstance) timeChartInstance.destroy();
            const sortedTimes = Object.keys(timeCount).sort();
            timeChartInstance = new Chart(ctx2, { type: 'bar', data: { labels: sortedTimes, datasets: [{ label: 'S·ªë l∆∞·ª£ng', data: sortedTimes.map(t=>timeCount[t]), backgroundColor: '#2563eb', borderRadius:4 }] }});
        }

        // --- C√ÅC TI·ªÜN √çCH (TOOLS) ---
        function togglePause() { isPaused = !isPaused; alert(isPaused ? "ƒê√£ T·∫°m d·ª´ng" : "ƒê√£ Ti·∫øp t·ª•c"); }
        function toggleDarkMode() { config.darkMode = !config.darkMode; applyUI(); }
        function toggleFullscreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function toggleClockUI() { document.querySelector('.realtime').style.opacity = document.querySelector('.realtime').style.opacity === '0' ? '1' : '0'; }
        
        function downloadQR() {
            const img = document.querySelector("#qrcode img");
            if(img) { const a = document.createElement("a"); a.href = img.src; a.download = "QR_Code.png"; a.click(); }
        }

        function zoomQR() { 
            document.getElementById("qrZoomModal").style.display = "flex"; 
            updateQR(); // V·∫Ω l·∫°i tr√™n modal
        }
        function closeZoom() { document.getElementById("qrZoomModal").style.display = "none"; }

        function toggleBlurQR() {
            document.getElementById("qrcode").classList.toggle("blur-effect");
        }

        function lockScreen() {
            document.getElementById("lockScreen").style.display = "flex";
            closeModal();
        }
        function unlockScreen() {
            const p = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ m·ªü:");
            if(p === config.pass) document.getElementById("lockScreen").style.display = "none";
            else alert("Sai m·∫≠t kh·∫©u!");
        }

        function randomStudent() {
            if(filteredData.length === 0) { alert("Danh s√°ch tr·ªëng!"); return; }
            const rd = filteredData[Math.floor(Math.random() * filteredData.length)];
            alert(`üéâ CH√öC M·ª™NG SINH VI√äN:\n\n${rd.name}\nMSSV: ${rd.mssv}\nL·ªõp: ${rd.class_name}`);
        }

        function exportCSV() {
            if(filteredData.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu!"); return; }
            let csv = "Gio,Ho Ten,MSSV,Lop\n";
            filteredData.forEach(i => csv += `${i.time},${i.name},${i.mssv},${i.class_name}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob); link.download = "DiemDanh.csv"; link.click();
        }

        function printList() {
            window.print(); // ƒê∆°n gi·∫£n nh·∫•t l√† in trang hi·ªán t·∫°i, ho·∫∑c c√≥ th·ªÉ m·ªü tab m·ªõi render b·∫£ng
        }

        function exportConfig() {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
            const a = document.createElement('a'); a.href = data; a.download = "config.json"; a.click();
        }

        function importConfig() {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const fr = new FileReader();
                fr.onload = ev => {
                    config = JSON.parse(ev.target.result);
                    localStorage.setItem('qr_config_max', JSON.stringify(config));
                    alert("ƒê√£ kh√¥i ph·ª•c! Trang s·∫Ω t·∫£i l·∫°i.");
                    location.reload();
                };
                fr.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function openFormLink() { window.open(config.link, "_blank"); }
        
        function showStaticQR() {
            // T·∫°o QR tƒ©nh c·ªßa Link Form (kh√¥ng c√≥ token th·ªùi gian)
            document.getElementById("qrZoomModal").style.display = "flex";
            const zDiv = document.getElementById("qrcodeZoom"); zDiv.innerHTML = "";
            new QRCode(zDiv, { text: config.link, width: 300, height: 300 });
        }

        function checkPing() { alert(navigator.onLine ? "‚úÖ M·∫°ng OK" : "‚ùå M·∫•t m·∫°ng"); }
        
        function toggleNote() {
            const n = document.getElementById("notePad");
            n.style.display = n.style.display === "none" ? "block" : "none";
        }
        function saveNote() {
            localStorage.setItem('admin_note', document.getElementById("adminNote").value);
            alert("ƒê√£ l∆∞u ghi ch√∫!");
        }

        function startTimer5() {
            let m = 5, s = 0;
            const timerDiv = document.getElementById("countdown");
            isPaused = true; // D·ª´ng QR
            const tInt = setInterval(() => {
                if(s === 0) { if(m === 0) { clearInterval(tInt); alert("H·∫øt gi·ªù!"); isPaused = false; return; } m--; s = 59; } else s--;
                timerDiv.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                timerDiv.style.color = "blue";
            }, 1000);
        }

        function deleteRow(idx, mssv) {
            if(!confirm("X√≥a sinh vi√™n n√†y?")) return;
            fetch(config.api, { method: 'POST', body: JSON.stringify({ action: "DELETE_ROW", row_index: idx, mssv: mssv }) })
            .then(res => res.json()).then(res => { if(res.status==="success") { alert("ƒê√£ x√≥a!"); fetchList(); } else alert("L·ªói!"); })
            .catch(() => alert("ƒê√£ g·ª≠i l·ªánh x√≥a!"));
        }
    </script>
</body>
</html>
