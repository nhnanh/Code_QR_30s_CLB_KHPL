<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QU·∫¢N TR·ªä ƒêI·ªÇM DANH - CLB KHPL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e74c3c;
            --bg-color: #f4f4f9;
        }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Icon Setting g√≥c tr√°i */
        .settings-btn {
            position: absolute; top: 20px; left: 20px;
            font-size: 30px; color: #7f8c8d; cursor: pointer;
            transition: 0.3s; z-index: 100;
        }
        .settings-btn:hover { color: var(--primary-color); transform: rotate(90deg); }

        /* Giao di·ªán ch√≠nh */
        h1 { color: var(--primary-color); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .qr-container {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center;
        }
        #qrcode img { border: 4px solid #333; border-radius: 5px; }
        
        .timer-box { margin-top: 20px; text-align: center; }
        .countdown { font-size: 48px; font-weight: bold; color: var(--accent-color); }
        .info-text { color: #7f8c8d; margin-top: 10px; font-size: 18px; }

        /* MODAL (C·ª≠a s·ªï ƒëƒÉng nh·∫≠p & Admin) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideDown 0.3s ease; position: relative; }
        
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: red; }

        /* Form Style */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.2s; }
        
        .btn-login { background: var(--primary-color); color: white; }
        .btn-save { background: #27ae60; color: white; }
        .btn-sheet { background: #2980b9; color: white; margin-bottom: 10px; display: block; text-align: center; text-decoration: none; line-height: 1.5;}
        .btn-pause { background: #f39c12; color: white; }
        
        button:hover, .btn-sheet:hover { opacity: 0.9; }
        .status-paused { color: red; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div class="settings-btn" onclick="openLoginModal()"><i class="fas fa-cog"></i></div>

    <div class="qr-container">
        <h1>Qu√©t M√£ ƒêi·ªÉm Danh</h1>
        <div id="qrcode"></div>
        
        <div class="timer-box">
            <div id="countdown" class="countdown">30</div>
            <div class="info-text">T·ª± ƒë·ªông ƒë·ªïi m√£ sau m·ªói phi√™n</div>
            <p id="pausedMsg" class="status-paused">‚õî H·ªÜ TH·ªêNG ƒêANG T·∫†M D·ª™NG</p>
        </div>
        <div style="margin-top: 20px; font-size: 14px; color: #999;">
            Th·ªùi gian th·ª±c: <span id="realtime">...</span>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align:center">üîí ƒêƒÉng nh·∫≠p Admin</h2>
            <div class="form-group">
                <label>M·∫≠t kh·∫©u qu·∫£n tr·ªã:</label>
                <input type="password" id="adminPassInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." onkeyup="if(event.key === 'Enter') checkLogin()">
            </div>
            <p id="loginError" style="color:red; display:none; text-align:center;">M·∫≠t kh·∫©u sai!</p>
            <button class="btn-login" onclick="checkLogin()">Truy c·∫≠p</button>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('adminModal')">&times;</span>
            <h2 style="text-align:center">‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h2>
            
            <div class="form-group">
                <a href="#" id="sheetLinkBtn" target="_blank" class="btn-sheet"><i class="fas fa-file-excel"></i> M·ªü Google Sheet Danh S√°ch</a>
            </div>

            <hr style="margin: 20px 0; border: 0.5px solid #eee;">

            <div class="form-group">
                <label>Link trang Form (form.html):</label>
                <input type="text" id="cfgLink" placeholder="https://.../form.html">
            </div>

            <div class="form-group">
                <label>Link Google Sheet (ƒê·ªÉ m·ªü nhanh):</label>
                <input type="text" id="cfgSheet" placeholder="https://docs.google.com/spreadsheets/...">
            </div>

            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Th·ªùi gian ƒë·ªïi QR (gi√¢y):</label>
                    <input type="number" id="cfgTime" min="5" value="30">
                </div>
                <div style="flex:1">
                    <label>ƒê·ªïi m·∫≠t kh·∫©u Admin:</label>
                    <input type="text" id="cfgPass" placeholder="M·∫≠t kh·∫©u m·ªõi...">
                </div>
            </div>

            <div class="form-group">
                <button class="btn-pause" id="btnPause" onclick="togglePause()">T·∫°m d·ª´ng h·ªá th·ªëng</button>
                <button class="btn-save" onclick="saveSettings()">üíæ L∆∞u C√†i ƒê·∫∑t</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. QU·∫¢N L√ù D·ªÆ LI·ªÜU & C·∫§U H√åNH ---
        // L·∫•y c·∫•u h√¨nh t·ª´ LocalStorage ho·∫∑c d√πng m·∫∑c ƒë·ªãnh
        let config = {
            formUrl: localStorage.getItem('adm_formUrl') || "",
            sheetUrl: localStorage.getItem('adm_sheetUrl') || "#",
            refreshTime: parseInt(localStorage.getItem('adm_refreshTime')) || 30,
            password: localStorage.getItem('adm_password') || "admin", // M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh
            isPaused: false
        };

        // Bi·∫øn to√†n c·ª•c
        let timer = config.refreshTime;
        let intervalId = null;
        let clockId = null;
        const qrContainer = document.getElementById("qrcode");

        // --- 2. LOGIC T·∫†O M√É QR ---
        function generateQR() {
            qrContainer.innerHTML = "";
            
            if (config.isPaused) {
                qrContainer.innerHTML = "<h3 style='color:red'>ƒê√É T·∫†M D·ª™NG</h3>";
                return;
            }

            if (!config.formUrl) {
                qrContainer.innerHTML = "<p>Ch∆∞a c·∫•u h√¨nh Link Form!<br>Vui l√≤ng v√†o c√†i ƒë·∫∑t.</p>";
                return;
            }

            // T·∫°o token d·ª±a tr√™n th·ªùi gian th·ª±c (gi√¢y)
            const token = Math.floor(Date.now() / 1000); 
            // Link ƒë√≠ch k√®m token: .../form.html?t=170xxxxxx
            const finalLink = `${config.formUrl}?t=${token}`;
            
            new QRCode(qrContainer, {
                text: finalLink,
                width: 280,
                height: 280,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }

        // V√≤ng l·∫∑p ƒë·∫øm ng∆∞·ª£c
        function startSystem() {
            if (intervalId) clearInterval(intervalId);
            
            // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
            generateQR();
            timer = config.refreshTime;
            updateDisplay();

            intervalId = setInterval(() => {
                if (!config.isPaused) {
                    timer--;
                    updateDisplay();
                    if (timer <= 0) {
                        timer = config.refreshTime;
                        generateQR(); // T·∫°o m√£ m·ªõi
                    }
                }
            }, 1000);
        }

        function updateDisplay() {
            document.getElementById("countdown").innerText = timer;
        }

        // ƒê·ªìng h·ªì th·ªùi gian th·ª±c
        setInterval(() => {
            document.getElementById("realtime").innerText = new Date().toLocaleString('vi-VN');
        }, 1000);


        // --- 3. X·ª¨ L√ù ADMIN & LOGIN ---
        function openLoginModal() {
            document.getElementById("loginModal").style.display = "flex";
            document.getElementById("adminPassInput").value = "";
            document.getElementById("loginError").style.display = "none";
            document.getElementById("adminPassInput").focus();
        }

        function checkLogin() {
            const inputPass = document.getElementById("adminPassInput").value;
            if (inputPass === config.password) {
                closeModal("loginModal");
                openAdminPanel();
            } else {
                document.getElementById("loginError").style.display = "block";
            }
        }

        function openAdminPanel() {
            document.getElementById("adminModal").style.display = "flex";
            // ƒê·ªï d·ªØ li·ªáu hi·ªán t·∫°i v√†o form
            document.getElementById("cfgLink").value = config.formUrl;
            document.getElementById("cfgSheet").value = config.sheetUrl;
            document.getElementById("cfgTime").value = config.refreshTime;
            document.getElementById("cfgPass").value = config.password;
            
            // C·∫≠p nh·∫≠t n√∫t Sheet
            const btnSheet = document.getElementById("sheetLinkBtn");
            btnSheet.href = config.sheetUrl && config.sheetUrl !== "#" ? config.sheetUrl : "#";
            if(config.sheetUrl === "#") btnSheet.style.opacity = "0.5";
            else btnSheet.style.opacity = "1";

            updatePauseBtn();
        }

        function saveSettings() {
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const newLink = document.getElementById("cfgLink").value;
            const newSheet = document.getElementById("cfgSheet").value;
            const newTime = parseInt(document.getElementById("cfgTime").value);
            const newPass = document.getElementById("cfgPass").value;

            if (!newLink) { alert("Link Form kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!"); return; }
            if (newTime < 5) { alert("Th·ªùi gian t·ªëi thi·ªÉu l√† 5 gi√¢y!"); return; }

            // L∆∞u v√†o Config & LocalStorage
            config.formUrl = newLink;
            config.sheetUrl = newSheet;
            config.refreshTime = newTime;
            config.password = newPass;

            localStorage.setItem('adm_formUrl', newLink);
            localStorage.setItem('adm_sheetUrl', newSheet);
            localStorage.setItem('adm_refreshTime', newTime);
            localStorage.setItem('adm_password', newPass);

            alert("ƒê√£ l∆∞u c√†i ƒë·∫∑t!");
            closeModal("adminModal");
            
            // Kh·ªüi ƒë·ªông l·∫°i h·ªá th·ªëng v·ªõi th√¥ng s·ªë m·ªõi
            startSystem();
        }

        // --- 4. T√çNH NƒÇNG PH·ª§ ---
        function togglePause() {
            config.isPaused = !config.isPaused;
            updatePauseBtn();
            
            const msg = document.getElementById("pausedMsg");
            if (config.isPaused) {
                msg.style.display = "block";
                qrContainer.innerHTML = "<h3 style='color:red; margin:50px 0;'>‚õî T·∫†M D·ª™NG</h3>";
                document.getElementById("countdown").innerText = "--";
            } else {
                msg.style.display = "none";
                startSystem(); // Ch·∫°y l·∫°i
            }
        }

        function updatePauseBtn() {
            const btn = document.getElementById("btnPause");
            if (config.isPaused) {
                btn.innerText = "‚ñ∂Ô∏è Ti·∫øp t·ª•c ƒëi·ªÉm danh";
                btn.style.background = "#27ae60";
            } else {
                btn.innerText = "‚è∏Ô∏è T·∫°m d·ª´ng h·ªá th·ªëng";
                btn.style.background = "#f39c12";
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = "none";
        }

        // ƒê√≥ng modal khi click ra ngo√†i
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        // --- KH·ªûI CH·∫†Y ---
        startSystem();

    </script>
</body>
</html>
