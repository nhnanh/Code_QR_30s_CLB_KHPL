<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #475569;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
            --accent: #ef4444;
        }

        body.dark-mode {
            --primary: #3b82f6;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        
        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* N√∫t C√†i ƒë·∫∑t */
        .settings-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 28px;
            color: var(--secondary);
            cursor: pointer;
            z-index: 100;
            padding: 10px;
            border-radius: 50%;
        }
        .settings-btn:hover { background: rgba(0,0,0,0.1); color: var(--primary); transform: rotate(90deg); transition: 0.4s; }

        /* Th·∫ª ch·ª©a QR ch√≠nh */
        .qr-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 380px;
            max-width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 { margin: 0 0 20px 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }

        #qrcode {
            background: white;
            padding: 15px;
            border-radius: 16px;
            display: inline-block;
            margin-bottom: 20px;
            border: 2px dashed #cbd5e1;
        }

        .timer-container { position: relative; height: 80px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .timer { font-size: 64px; font-weight: 900; color: var(--accent); line-height: 1; font-variant-numeric: tabular-nums; }
        .label { font-size: 14px; color: var(--secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .realtime {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--bg);
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* D√≤ng ch·ªØ ch·∫°y */
        .marquee-box {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--accent);
            color: white;
            padding: 12px 0;
            font-weight: bold;
            font-size: 18px;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }

        /* MODAL ADMIN */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--bg); padding-bottom: 15px; }
        .modal-title { font-size: 20px; font-weight: bold; }
        .close-btn { font-size: 28px; cursor: pointer; color: var(--secondary); }
        .close-btn:hover { color: var(--accent); }

        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-weight: 700; cursor: pointer; margin-top: 10px;
            font-size: 16px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-save { background: var(--primary); color: white; }
        .btn-logout { background: var(--bg); color: var(--text); border: 1px solid #cbd5e1; }

        /* Grid t√≠nh nƒÉng n√¢ng cao */
        .features-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .feature-item {
            background: var(--bg); padding: 15px 10px; border-radius: 10px;
            text-align: center; cursor: pointer; font-size: 13px; font-weight: 600;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .feature-item:hover { background: #e2e8f0; }
        body.dark-mode .feature-item:hover { background: #334155; }
        .feature-item i { font-size: 20px; margin-bottom: 5px; color: var(--primary); }

        /* Tr·∫°ng th√°i t·∫°m d·ª´ng */
        .paused-overlay { color: var(--accent); font-weight: bold; font-size: 20px; display: none; margin: 20px 0;}
    </style>
</head>
<body>

    <div class="settings-btn" onclick="requestLogin()" title="C√†i ƒë·∫∑t Admin">
        <i class="fa-solid fa-gear"></i>
    </div>

    <div class="qr-card" id="mainCard">
        <h1 id="orgName">ƒêI·ªÇM DANH CLB</h1>

        <div id="qrWrapper">
            <div id="qrcode"></div>
        </div>

        <div id="pausedText" class="paused-overlay">
            <i class="fa-solid fa-pause"></i><br>H·ªÜ TH·ªêNG T·∫†M D·ª™NG
        </div>

        <div class="timer-container" id="timerBox">
            <div class="timer" id="countdown">--</div>
            <div class="label">L√†m m·ªõi sau (gi√¢y)</div>
        </div>

        <div class="realtime">
            <i class="fa-regular fa-clock"></i>
            <span id="clock">Loading...</span>
        </div>
    </div>

    <div class="marquee-box" id="marquee">
        <marquee>üì¢ H·ªÜ TH·ªêNG ƒêANG M·ªû ƒêI·ªÇM DANH. VUI L√íNG QU√âT M√É TR∆Ø·ªöC KHI H·∫æT GI·ªú!</marquee>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fa-solid fa-user-shield"></i> Qu·∫£n Tr·ªã Vi√™n</div>
                <div class="close-btn" onclick="closeModal()">&times;</div>
            </div>

            <div class="form-group">
                <label>Link trang Form (form.html):</label>
                <input type="text" id="cfgLink" placeholder="https://...">
            </div>
            
            <div class="form-group">
                <label>Link Google Sheet (K·∫øt qu·∫£):</label>
                <input type="text" id="cfgSheet" placeholder="https://docs.google.com...">
            </div>

            <div class="form-group" style="display:flex; gap:10px">
                <div style="flex:1">
                    <label>Th·ªùi gian ƒë·ªïi (s):</label>
                    <input type="number" id="cfgTime" value="30" min="5">
                </div>
                <div style="flex:1">
                    <label>M·∫≠t kh·∫©u Admin:</label>
                    <input type="text" id="cfgPass">
                </div>
            </div>

            <button class="btn btn-save" onclick="saveConfig()">L∆ØU C√ÄI ƒê·∫∂T</button>

            <div style="margin-top: 25px; font-weight:bold; font-size:14px; color:var(--secondary)">üöÄ T√çNH NƒÇNG N√ÇNG CAO</div>
            <div class="features-grid">
                <div class="feature-item" onclick="togglePause()"><i class="fa-solid fa-play-pause"></i>T·∫°m d·ª´ng/Ti·∫øp t·ª•c</div>
                <div class="feature-item" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i>Ch·∫ø ƒë·ªô T·ªëi/S√°ng</div>
                <div class="feature-item" onclick="changeTitle()"><i class="fa-solid fa-pen-to-square"></i>ƒê·ªïi Ti√™u ƒë·ªÅ</div>
                <div class="feature-item" onclick="toggleMarquee()"><i class="fa-solid fa-bullhorn"></i>B·∫≠t/T·∫Øt Ch·ªØ ch·∫°y</div>
                <div class="feature-item" onclick="openSheet()"><i class="fa-solid fa-table"></i>M·ªü Sheet D·ªØ li·ªáu</div>
                <div class="feature-item" onclick="toggleFullscreen()"><i class="fa-solid fa-expand"></i>To√†n m√†n h√¨nh</div>
                <div class="feature-item" onclick="downloadQR()"><i class="fa-solid fa-download"></i>T·∫£i ·∫£nh QR</div>
                <div class="feature-item" onclick="checkNetwork()"><i class="fa-solid fa-wifi"></i>Ki·ªÉm tra m·∫°ng</div>
                <div class="feature-item" onclick="resetDefaults()"><i class="fa-solid fa-rotate-left"></i>Reset M·∫∑c ƒë·ªãnh</div>
                <div class="feature-item" onclick="closeModal()" style="color:var(--accent)"><i class="fa-solid fa-right-from-bracket"></i>Tho√°t Admin</div>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH M·∫∂C ƒê·ªäNH ---
        const DEFAULT_CONFIG = {
            link: "https://nhnanh.github.io/Code_QR_30s_CLB_KHPL/form.html", // Link m·∫∑c ƒë·ªãnh c·ªßa b·∫°n
            sheet: "",
            time: 30,
            pass: "Admin",
            title: "ƒêI·ªÇM DANH CLB",
            darkMode: false
        };

        // Bi·∫øn to√†n c·ª•c
        let config = loadConfig();
        let timer = config.time;
        let intervalId = null;
        let qrObject = null;
        let isPaused = false;

        // --- KH·ªûI T·∫†O ---
        window.onload = function() {
            applyConfigUI();
            startClock();
            startSystem();
        };

        // --- C√ÅC H√ÄM X·ª¨ L√ù CH√çNH ---
        
        function startSystem() {
            if (intervalId) clearInterval(intervalId);
            
            // Render l·∫ßn ƒë·∫ßu
            generateQR();
            timer = config.time;
            updateTimerDisplay();

            // V√≤ng l·∫∑p
            intervalId = setInterval(() => {
                if (!isPaused) {
                    timer--;
                    updateTimerDisplay();
                    if (timer <= 0) {
                        timer = config.time;
                        generateQR(); // T·∫°o m√£ m·ªõi
                    }
                }
            }, 1000);
        }

        function generateQR() {
            const qrDiv = document.getElementById("qrcode");
            
            // T·∫°o link duy nh·∫•t theo th·ªùi gian (Token)
            const token = Date.now(); 
            const finalLink = `${config.link}?t=${token}`;

            if (qrObject === null) {
                qrDiv.innerHTML = "";
                qrObject = new QRCode(qrDiv, {
                    text: finalLink,
                    width: 250,
                    height: 250,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
            } else {
                qrObject.clear();
                qrObject.makeCode(finalLink);
            }
        }

        function updateTimerDisplay() {
            document.getElementById("countdown").innerText = timer;
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById("clock").innerText = now.toLocaleTimeString("vi-VN") + " - " + now.toLocaleDateString("vi-VN");
            }, 1000);
        }

        // --- QU·∫¢N L√ù D·ªÆ LI·ªÜU (LOCAL STORAGE) ---
        function loadConfig() {
            const saved = localStorage.getItem("qr_config_v2");
            return saved ? { ...DEFAULT_CONFIG, ...JSON.parse(saved) } : DEFAULT_CONFIG;
        }

        function saveConfigToStorage() {
            localStorage.setItem("qr_config_v2", JSON.stringify(config));
        }

        function applyConfigUI() {
            document.getElementById("orgName").innerText = config.title;
            if (config.darkMode) document.body.classList.add("dark-mode");
            else document.body.classList.remove("dark-mode");
        }

        // --- ADMIN & MODAL ---
        function requestLogin() {
            const input = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
            if (input === config.pass) {
                openModal();
            } else if (input !== null) {
                alert("Sai m·∫≠t kh·∫©u!");
            }
        }

        function openModal() {
            document.getElementById("adminModal").style.display = "flex";
            // Fill data
            document.getElementById("cfgLink").value = config.link;
            document.getElementById("cfgSheet").value = config.sheet;
            document.getElementById("cfgTime").value = config.time;
            document.getElementById("cfgPass").value = config.pass;
        }

        function closeModal() {
            document.getElementById("adminModal").style.display = "none";
        }

        function saveConfig() {
            config.link = document.getElementById("cfgLink").value;
            config.sheet = document.getElementById("cfgSheet").value;
            config.time = parseInt(document.getElementById("cfgTime").value);
            config.pass = document.getElementById("cfgPass").value;
            
            saveConfigToStorage();
            alert("ƒê√£ l∆∞u c√†i ƒë·∫∑t!");
            closeModal();
            startSystem(); // Reset l·∫°i h·ªá th·ªëng
        }

        // --- T√çNH NƒÇNG N√ÇNG CAO ---
        
        function togglePause() {
            isPaused = !isPaused;
            const pausedText = document.getElementById("pausedText");
            const qrWrapper = document.getElementById("qrWrapper");
            const timerBox = document.getElementById("timerBox");

            if (isPaused) {
                pausedText.style.display = "block";
                qrWrapper.style.opacity = "0.1";
                timerBox.style.visibility = "hidden";
            } else {
                pausedText.style.display = "none";
                qrWrapper.style.opacity = "1";
                timerBox.style.visibility = "visible";
                generateQR(); // T·∫°o m·ªõi ngay khi ti·∫øp t·ª•c
            }
        }

        function toggleDarkMode() {
            config.darkMode = !config.darkMode;
            applyConfigUI();
            saveConfigToStorage();
        }

        function changeTitle() {
            const t = prompt("Nh·∫≠p ti√™u ƒë·ªÅ m·ªõi:", config.title);
            if (t) {
                config.title = t;
                applyConfigUI();
                saveConfigToStorage();
            }
        }

        function toggleMarquee() {
            const m = document.getElementById("marquee");
            m.style.display = (m.style.display === "none" || m.style.display === "") ? "block" : "none";
        }

        function openSheet() {
            if (config.sheet) window.open(config.sheet, "_blank");
            else alert("Ch∆∞a nh·∫≠p link Google Sheet trong c√†i ƒë·∫∑t!");
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function downloadQR() {
            const img = document.querySelector("#qrcode img");
            if (img) {
                const link = document.createElement("a");
                link.download = "QR_Code.png";
                link.href = img.src;
                link.click();
            } else {
                alert("ƒê·ª£i QR t·∫£i xong ƒë√£!");
            }
        }

        function checkNetwork() {
            alert(navigator.onLine ? "‚úÖ M·∫°ng ·ªïn ƒë·ªãnh" : "‚ùå M·∫•t k·∫øt n·ªëi internet");
        }

        function resetDefaults() {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c c√†i ƒë·∫∑t g·ªëc?")) {
                localStorage.removeItem("qr_config_v2");
                location.reload();
            }
        }

    </script>
</body>
</html>
